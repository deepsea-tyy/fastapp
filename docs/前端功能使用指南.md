# 前端功能使用指南

本文档介绍 FastApp 前端框架的核心功能使用方法。

## 一、响应式布局

### 1.1 响应式断点

FastApp 使用以下响应式断点：

| 断点 | 宽度范围 | 设备类型 | 说明 |
|------|---------|---------|------|
| **xs** | < 768px | 移动端 | 手机、小屏设备 |
| **sm** | 768px - 992px | 平板 | 平板设备 |
| **md** | 992px - 1200px | 中等屏幕 | 小屏笔记本 |
| **lg** | 1200px - 1920px | 大屏幕 | 桌面显示器 |
| **xl** | ≥ 1920px | 超大屏幕 | 大屏显示器 |

**移动端判断**：屏幕宽度 < 1024px 时自动切换为移动端模式。

### 1.2 表单响应式布局

使用 `useFormResponsive` Hook 实现表单自适应布局：

```vue
<script setup lang="ts">
import useFormResponsive from '@/hooks/useFormResponsive'

const formRef = ref<MaFormExpose>()

useFormResponsive(formRef, {
  xsLabelPosition: 'top',    // 小屏：标签在上方
  smLabelPosition: 'right',  // 中屏：标签在右侧
  lgLabelPosition: 'right',  // 大屏：标签在右侧
})
</script>
```

**配置选项**：`xsLabelPosition`、`smLabelPosition`、`lgLabelPosition`（标签位置），`xsLabelWidth`、`smLabelWidth`、`lgLabelWidth`（标签宽度）

### 1.3 抽屉响应式宽度

抽屉宽度会根据屏幕尺寸自动调整：

```typescript
const { Drawer, open } = useDrawer({
  xsSize: '90%',  // 小屏
  smSize: '75%',  // 中屏
  mdSize: '65%',  // 中大屏
  lgSize: '50%',  // 大屏
})
```

### 1.4 移动端状态

```typescript
const settingStore = useSettingStore()
const isMobile = settingStore.getMobileState() // < 1024px 返回 true
```

## 二、文件上传

### 2.1 视频上传

```vue
<template>
  <ma-upload-video
    v-model="videoUrl"
    :file-size="100 * 1024 * 1024"
    :file-type="['mp4', 'avi', 'mov']"
  />
</template>
```

**主要属性**：`fileSize`（大小限制）、`fileType`（格式）、`enableChunkUpload`（分片上传）、`chunkThreshold`（分片阈值，默认10MB）

**编辑器插入**：通过资源选择器插入视频，支持 mp4、webm、ogg、avi、mov、wmv 格式

### 2.2 分片上传

大文件自动分片上传：

```typescript
import { chunkUpload, shouldUseChunkUpload } from '@/utils/chunkUpload'

// 判断是否需要分片上传（> 10MB）
if (shouldUseChunkUpload(file, 10 * 1024 * 1024)) {
  const result = await chunkUpload({
    file,
    chunkSize: 2 * 1024 * 1024,  // 分片大小 2MB
    onProgress: (progress) => console.log(`进度: ${progress}%`)
  })
}
```

**流程**：计算MD5 → 文件分片 → 并发上传 → 合并分片 → 返回URL

**后端接口**：
- `POST /attachment/chunk-upload`：上传分片
- `POST /attachment/chunk-merge`：合并分片

### 2.3 普通文件上传

```typescript
import { uploadLocal } from '@/utils/uploadLocal'

const result = await uploadLocal({ file }, '/custom/upload', 'customFile')
```

## 三、字典数据

### 3.1 字典数据结构

```typescript
interface Dictionary {
  label: string        // 显示标签
  value: any          // 值
  i18n?: string       // 国际化key
  color?: string      // 颜色标记
  disabled?: boolean  // 是否禁用
}
```

### 3.2 字典Store操作

```typescript
const dictStore = useDictStore()

dictStore.find('role-dataScope')           // 查找字典
dictStore.push('my-dict', [...])           // 添加字典
dictStore.t('role-dataScope', 1, 'label')  // 翻译字典值
dictStore.remove('my-dict')                // 删除字典
```

### 3.3 字典组件

```vue
<!-- 选择器 -->
<ma-dict-select v-model="value" dict-name="role-dataScope" />

<!-- 单选框 -->
<ma-dict-radio v-model="value" dict-name="role-dataScope" />
<ma-dict-radio v-model="value" dict-name="role-dataScope" render-mode="button" />

<!-- 复选框 -->
<ma-dict-checkbox v-model="values" dict-name="role-dataScope" />
```

### 3.4 字典数据定义

在 `web/src/provider/dictionary/data/` 或插件 `web/dictionary/` 目录创建：

```typescript
export default [
  { label: '选项1', value: 1, i18n: 'dict.option1', color: 'primary' },
] as Dictionary[]
```

**命名规则**：文件名即为字典名称，应用启动时自动加载

## 四、表格组件

### 4.1 MaProTable 高级表格

集成搜索、分页、操作的完整表格组件：

```vue
<template>
  <MaProTable ref="proTableRef" :options="options" :schema="schema" />
</template>

<script setup lang="ts">
const proTableRef = ref<MaProTableExpose>()
const options = ref({
  requestOptions: { api: page },
})
const schema = ref({
  searchItems: getSearchItems(),
  tableColumns: getTableColumns(),
})
</script>
```

**列配置**（`getTableColumns.tsx`）：
```tsx
export default function getTableColumns(): MaProTableColumns[] {
  return [
    { type: 'selection' },
    { type: 'index' },
    { label: () => '用户名', prop: 'username', minWidth: 120 },
    {
      label: () => '状态',
      prop: 'status',
      cellRender: ({ row }) => <ElTag type={row.status === 1 ? 'success' : 'danger'}>
        {row.status === 1 ? '启用' : '禁用'}
      </ElTag>
    },
    {
      type: 'operation',
      operationConfigure: {
        actions: [{ name: 'edit', onClick: ({ row }) => {} }]
      }
    }
  ]
}
```

**搜索配置**（`getSearchItems.tsx`）：
```tsx
export default function getSearchItems(): MaSearchItem[] {
  return [
    { label: () => '用户名', prop: 'username', render: 'input' },
    { label: () => '状态', prop: 'status', render: () => MaDictSelect, renderProps: { dictName: 'system-status' } },
  ]
}
```

**常用操作**：
```typescript
proTableRef.value.refresh()                    // 刷新
proTableRef.value.setRequestParams({...}, true) // 设置参数并刷新
proTableRef.value.getSelections()              // 获取选中行
```

### 4.2 MaTable 基础表格

```vue
<ma-table ref="table" />
<script setup>
useTable('table').then((table) => {
  table.setColumns([...])
  table.setData([...])
})
</script>
```

### 4.3 MaSelectTable 选择表格

```vue
<ma-select-table v-model="selected" :api="page" row-key="id" show-key="name" />
```

## 五、插件前端开发

插件前端代码位于 `plugin/{org}/{plugin}/web/`，安装时自动复制到 `web/src/plugins/{org}/{plugin}/`。

### 5.1 目录结构

```
plugin/{org}/{plugin}/web/
├── api/              # API接口定义
├── views/            # Vue页面组件
│   └── */index.vue   # 列表页
│   └── */form.vue    # 表单页
│   └── */data/       # 配置数据
├── locales/          # 多语言文件
├── dictionary/       # 字典数据（可选）
└── index.ts          # 插件入口（可选）
```

### 5.2 API接口定义

```typescript
// plugin/ds/article/web/api/article.ts
export interface ArticleVo { id: number; title: string; }

export function page(params: any) {
  return useHttp().get('/admin/article/article/list', { params })
}
```

**使用**：`import { page } from '$/ds/article/api/article.ts'`

### 5.3 视图组件

列表页和表单页开发方式与主应用相同，使用 `MaProTable` 和 `ma-form` 组件。

### 5.4 多语言和字典

- **多语言**：在 `web/locales/` 创建 `zh_CN[简体中文].yaml` 等文件
- **字典**：在 `web/dictionary/` 创建字典文件，自动加载

### 5.5 路径别名

- `$/`：插件根目录（`$/ds/article/api/article.ts`）
- `@/`：前端项目根目录
- `~/`：前端 src 目录

### 5.6 安装与卸载

```bash
php bin/hyperf.php plugin:install ds/article    # 安装
php bin/hyperf.php plugin:uninstall ds/article # 卸载
```

**注意**：修改后需重新安装，开发时可直接在 `web/src/plugins/` 修改

## 六、常见问题

**Q1: 视频上传失败？**  
检查文件大小、格式、网络连接和后端接口。

**Q2: 分片上传进度不准确？**  
进度包括MD5计算（5%）、分片上传（10%-90%）、合并（90%-100%），确保 `onProgress` 正确更新UI。

**Q3: 字典数据找不到？**  
检查文件目录、文件名是否与字典名称一致。

**Q4: 表格数据不刷新？**  
调用 `proTableRef.value.refresh()` 或 `setRequestParams({...}, true)`。

**Q5: 表单在小屏幕显示异常？**  
使用 `useFormResponsive`，设置 `xsLabelPosition: 'top'`。

**Q6: 如何判断移动端？**  
使用 `useSettingStore().getMobileState()`（< 1024px 返回 true）。

**Q7: 插件前端代码修改后不生效？**  
重新安装插件，或开发时直接在 `web/src/plugins/` 修改。

**Q8: 如何引用插件API？**  
使用路径别名：`import { page } from '$/ds/article/api/article.ts'`
