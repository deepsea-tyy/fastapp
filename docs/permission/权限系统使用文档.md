# æƒé™ç³»ç»Ÿä½¿ç”¨æ–‡æ¡£

## ç³»ç»Ÿæ¦‚è¿°

åŸºäº RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰çš„æƒé™ç³»ç»Ÿï¼ŒåŒ…å«ä¸¤å¤§æ ¸å¿ƒæ¨¡å—ï¼š

1. **åŠŸèƒ½æƒé™**ï¼šæ§åˆ¶ç”¨æˆ·å¯ä»¥è®¿é—®å“ªäº›èœå•å’ŒåŠŸèƒ½
2. **æ•°æ®æƒé™**ï¼šæ§åˆ¶ç”¨æˆ·å¯ä»¥è®¿é—®å“ªäº›æ•°æ®èŒƒå›´

### æƒé™ç³»ç»Ÿæ¶æ„

```
ç”¨æˆ· (User) â†’ è§’è‰² (Role) â†’ èœå• (Menu)
                â†“
           æ•°æ®èŒƒå›´ (data_scope)
                â†“
        ç”¨æˆ·æ‰€å±éƒ¨é—¨ (user_admin_setting.dept_id)
        è§’è‰²å¯è®¿é—®çš„éƒ¨é—¨æ•°æ®æƒé™ (role_belongs_department)
```

### æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ | è¯´æ˜ |
|------|------|
| **ç”¨æˆ·ï¼ˆUserï¼‰** | ç³»ç»Ÿä½¿ç”¨è€… |
| **è§’è‰²ï¼ˆRoleï¼‰** | æƒé™é›†åˆï¼ŒåŒ…å«åŠŸèƒ½æƒé™å’Œæ•°æ®æƒé™ |
| **èœå•ï¼ˆMenuï¼‰** | åŠŸèƒ½æƒé™çš„æœ€å°å•ä½ï¼Œé€šè¿‡èœå•åç§°ï¼ˆnameï¼‰æ ‡è¯† |
| **æ•°æ®èŒƒå›´ï¼ˆdata_scopeï¼‰** | æ•°æ®æƒé™ç±»å‹ï¼Œå†³å®šç”¨æˆ·å¯ä»¥è®¿é—®çš„æ•°æ®èŒƒå›´ |

## åŠŸèƒ½æƒé™ç³»ç»Ÿ

### æƒé™æ¨¡å‹

åŠŸèƒ½æƒé™é‡‡ç”¨ **ç”¨æˆ· â†’ è§’è‰² â†’ èœå•** çš„æ¨¡å‹ï¼š

- ç”¨æˆ·å¯ä»¥è¢«åˆ†é…å¤šä¸ªè§’è‰²
- è§’è‰²å¯ä»¥å…³è”å¤šä¸ªèœå•
- ç”¨æˆ·çš„æƒé™ = ç”¨æˆ·æ‰€æœ‰**æ­£å¸¸çŠ¶æ€**è§’è‰²çš„èœå•é›†åˆï¼ˆå»é‡ï¼‰
- åªæœ‰çŠ¶æ€ä¸ºæ­£å¸¸ï¼ˆstatus=1ï¼‰çš„è§’è‰²æ‰ä¼šå‚ä¸æƒé™åˆ¤æ–­

### æ•°æ®åº“è¡¨ç»“æ„

| è¡¨å | å…³é”®å­—æ®µ | è¯´æ˜ |
|------|---------|------|
| `user` | id, username, status | ç”¨æˆ·è¡¨ |
| `role` | id, name, code, data_scope, status | è§’è‰²è¡¨ |
| `menu` | id, name, path, parent_id, status, meta | èœå•è¡¨ï¼ˆnameä¸ºæƒé™æ ‡è¯†ï¼‰ |
| `user_belongs_role` | user_id, role_id | ç”¨æˆ·è§’è‰²å…³è”è¡¨ |
| `role_belongs_menu` | role_id, menu_id | è§’è‰²èœå•å…³è”è¡¨ |
| `role_belongs_department` | role_id, dept_id | è§’è‰²éƒ¨é—¨å…³è”è¡¨ï¼ˆç”¨äºè‡ªå®šä¹‰æ•°æ®æƒé™ï¼Œè¡¨ç¤ºè§’è‰²å¯è®¿é—®çš„éƒ¨é—¨æ•°æ®æƒé™ï¼‰ |
| `user_admin_setting` | user_id, dept_id | ç”¨æˆ·è®¾ç½®è¡¨ï¼ˆdept_idä¸ºJSONæ•°ç»„ï¼Œè¡¨ç¤ºç”¨æˆ·æ‰€å±çš„éƒ¨é—¨ï¼‰

### æƒé™æ£€æŸ¥æœºåˆ¶

ç³»ç»Ÿé€šè¿‡ `PermissionMiddleware` ä¸­é—´ä»¶è‡ªåŠ¨è¿›è¡Œæƒé™éªŒè¯ï¼š
1. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
2. è¶…çº§ç®¡ç†å‘˜è·³è¿‡æƒé™æ£€æŸ¥
3. è§£ææ§åˆ¶å™¨å’Œæ–¹æ³•çš„ `@Permission` æ³¨è§£
4. éªŒè¯ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æ‰€éœ€æƒé™

#### Permission æ³¨è§£

```php
use App\Http\Admin\Permission;

#[Permission(code: 'user.list')]
class UserController extends AbstractController
{
    #[Permission(code: ['user.create', 'user.edit'], operation: Permission::OPERATION_OR)]
    public function create()
    {
        // éœ€è¦æ‹¥æœ‰ user.create æˆ– user.edit æƒé™
    }
}
```

**æ³¨è§£å‚æ•°**ï¼š
- `code`: æƒé™ç ï¼ˆèœå•åç§°ï¼‰ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–æ•°ç»„
- `operation`: æ“ä½œç¬¦
  - `Permission::OPERATION_AND`ï¼šéœ€è¦æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼ˆé»˜è®¤ï¼‰
  - `Permission::OPERATION_OR`ï¼šåªéœ€æ‹¥æœ‰å…¶ä¸­ä¸€ä¸ªæƒé™

### æƒé™æ£€æŸ¥æ–¹æ³•

#### åç«¯æ£€æŸ¥

```php
use App\Http\CurrentUser;
use App\Model\User;

// Adminæ§åˆ¶å™¨
$user = $currentUser->adminUser();
$hasPermission = $user->hasPermission('user.list');
$permissions = $user->getPermissions(); // è¿”å›èœå•é›†åˆï¼ˆå·²å»é‡ï¼‰
$isSuperAdmin = $user->isSuperAdmin();

// Apiæ§åˆ¶å™¨
$user = $currentUser->user();
$hasPermission = $user->hasPermission('user.list');
```

#### å‰ç«¯æ£€æŸ¥

```typescript
import hasAuth from '@/utils/permission/hasAuth'
import hasRole from '@/utils/permission/hasRole'
import hasUser from '@/utils/permission/hasUser'

// å•ä¸ªæƒé™
if (hasAuth('user.list')) { /* æœ‰æƒé™ */ }

// å¤šä¸ªæƒé™ï¼ˆORå…³ç³»ï¼‰
if (hasAuth(['user.create', 'user.edit'])) { /* æœ‰ä»»ä¸€æƒé™å³å¯ */ }

// æ£€æŸ¥è§’è‰²å’Œç”¨æˆ·
if (hasRole('admin')) { /* æœ‰è§’è‰² */ }
if (hasUser('admin')) { /* æ˜¯ç‰¹å®šç”¨æˆ· */ }
```

### ä½¿ç”¨ç¤ºä¾‹

#### æ§åˆ¶å™¨æƒé™æ§åˆ¶

```php
use App\Http\Admin\Permission;
use Hyperf\HttpServer\Annotation\Middleware;
use App\Common\Middleware\AccessTokenMiddleware;
use App\Http\Admin\Middleware\PermissionMiddleware;

#[Middleware(middleware: AccessTokenMiddleware::class, priority: 100)]
#[Middleware(middleware: PermissionMiddleware::class, priority: 99)]
#[Permission(code: 'user.manage')] // ç±»çº§åˆ«æƒé™
class UserController extends AbstractController
{
    #[Permission(code: 'user.list')] // æ–¹æ³•çº§åˆ«æƒé™
    public function list() { /* ç”¨æˆ·åˆ—è¡¨ */ }

    #[Permission(code: ['user.create', 'user.edit'], operation: Permission::OPERATION_OR)]
    public function save() { /* éœ€è¦ user.create æˆ– user.edit æƒé™ */ }
}
```

**æ³¨æ„**ï¼šç±»çº§åˆ«å’Œæ–¹æ³•çº§åˆ«çš„æƒé™éƒ½ä¼šç”Ÿæ•ˆï¼Œè¶…çº§ç®¡ç†å‘˜è‡ªåŠ¨è·³è¿‡æƒé™æ£€æŸ¥ã€‚

#### å‰ç«¯æƒé™æ§åˆ¶

```vue
<template>
  <el-button v-if="hasAuth('user.create')" @click="handleCreate">æ–°å¢ç”¨æˆ·</el-button>
  <el-button v-if="hasRole('admin')" @click="handleAdmin">ç®¡ç†å‘˜æ“ä½œ</el-button>
</template>

<script setup lang="ts">
import hasAuth from '@/utils/permission/hasAuth'
import hasRole from '@/utils/permission/hasRole'
</script>
```

#### è·¯ç”±æƒé™æ§åˆ¶

```typescript
{
  path: '/user',
  component: Layout,
  meta: {
    auth: ['user.manage'], // éœ€è¦æƒé™
    role: ['admin'],       // éœ€è¦è§’è‰²
    user: ['admin']        // ä»…ç‰¹å®šç”¨æˆ·
  }
}
```

## æ•°æ®æƒé™ç³»ç»Ÿ

> ğŸ“– **è¯¦ç»†è¯´æ˜**ï¼šæ•°æ®æƒé™çš„å®Œæ•´å®ç°åŸç†ã€é…åˆæ–¹å¼ã€æŸ¥è¯¢é€»è¾‘ç­‰è¯¦ç»†å†…å®¹è¯·å‚è€ƒ [ç”¨æˆ·éƒ¨é—¨ä¸è§’è‰²éƒ¨é—¨é…åˆä½¿ç”¨è¯¦è§£](./ç”¨æˆ·éƒ¨é—¨ä¸è§’è‰²éƒ¨é—¨é…åˆä½¿ç”¨è¯¦è§£.md)

### æ•°æ®æƒé™ç±»å‹

| ç±»å‹ | å€¼ | è¯´æ˜ | æ•°æ®æº |
|------|-----|------|--------|
| å…¨éƒ¨æ•°æ®æƒé™ | 1 | å¯è®¿é—®æ‰€æœ‰æ•°æ® | æ—  |
| è‡ªå®šä¹‰æ•°æ®æƒé™ | 2 | å¯è®¿é—®æŒ‡å®šéƒ¨é—¨çš„æ•°æ® | role_belongs_departmentï¼ˆè§’è‰²å¯è®¿é—®çš„éƒ¨é—¨æ•°æ®æƒé™ï¼‰ |
| æœ¬éƒ¨é—¨æ•°æ®æƒé™ | 3 | åªèƒ½è®¿é—®æœ¬éƒ¨é—¨æ•°æ® | user_admin_setting.dept_idï¼ˆç”¨æˆ·æ‰€å±çš„éƒ¨é—¨ï¼‰ |
| æœ¬éƒ¨é—¨åŠä»¥ä¸‹æ•°æ®æƒé™ | 4 | å¯è®¿é—®æœ¬éƒ¨é—¨åŠå­éƒ¨é—¨æ•°æ® | user_admin_setting.dept_idï¼ˆç”¨æˆ·æ‰€å±çš„éƒ¨é—¨ï¼‰ |
| æœ¬äººæ•°æ®æƒé™ | 5 | åªèƒ½è®¿é—®è‡ªå·±åˆ›å»ºçš„æ•°æ® | å½“å‰ç”¨æˆ·ID |

### æ•°æ®æƒé™ä¼˜å…ˆçº§

å½“ç”¨æˆ·æ‹¥æœ‰å¤šä¸ªè§’è‰²æ—¶ï¼ŒæŒ‰ç…§ä»¥ä¸‹ä¼˜å…ˆçº§ç¡®å®šæ•°æ®æƒé™ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š

1. **å…¨éƒ¨æƒé™ï¼ˆdata_scope=1ï¼‰** - æœ€é«˜ä¼˜å…ˆçº§
2. **è‡ªå®šä¹‰æƒé™ï¼ˆdata_scope=2ï¼‰** - åˆå¹¶æ‰€æœ‰è‡ªå®šä¹‰è§’è‰²çš„éƒ¨é—¨ID
3. **æœ¬éƒ¨é—¨åŠä»¥ä¸‹ï¼ˆdata_scope=4ï¼‰**
4. **æœ¬éƒ¨é—¨ï¼ˆdata_scope=3ï¼‰**
5. **æœ¬äººï¼ˆdata_scope=5ï¼‰** - æœ€ä½ä¼˜å…ˆçº§

### å®ç°åŸç†

æ•°æ®æƒé™åŸºäº **æ•°æ®åˆ›å»ºè€…ï¼ˆcreated_byï¼‰** è¿›è¡Œè¿‡æ»¤ï¼š
1. æ ¹æ®è§’è‰²çš„ `data_scope` ç¡®å®šæ•°æ®æƒé™èŒƒå›´
2. æ ¹æ®æƒé™èŒƒå›´è·å–å¯è®¿é—®çš„ç”¨æˆ·IDåˆ—è¡¨
3. ä½¿ç”¨ `whereIn('created_by', $userIds)` æˆ– `where('created_by', $userId)` è¿‡æ»¤æ•°æ®

### ä½¿ç”¨ DataScopeTool

#### åŸºæœ¬ä½¿ç”¨

```php
use App\Http\Admin\Service\Permission\DataScopeTool;

// åœ¨ Repository ä¸­åº”ç”¨æ•°æ®æƒé™
public function list(array $params): Collection
{
    $query = Model::query();
    
    // åº”ç”¨æ•°æ®æƒé™è¿‡æ»¤ï¼ˆ0 è¡¨ç¤ºä½¿ç”¨å½“å‰ç™»å½•ç”¨æˆ·ï¼‰
    DataScopeTool::applyUserDataScope(0, $query);
    
    // å…¶ä»–æŸ¥è¯¢æ¡ä»¶
    if (isset($params['keyword'])) {
        $query->where('name', 'like', "%{$params['keyword']}%");
    }
    
    return $query->get();
}
```

#### æ¸…é™¤ç”¨æˆ·ç¼“å­˜

å½“ç”¨æˆ·è§’è‰²æˆ–éƒ¨é—¨å˜æ›´æ—¶ï¼Œéœ€è¦æ¸…é™¤ç¼“å­˜ï¼š

```php
use App\Http\Admin\Service\Permission\DataScopeTool;

// æ›´æ–°ç”¨æˆ·ä¿¡æ¯åæ¸…é™¤ç¼“å­˜
User::query()->where('id', $userId)->update($data);
DataScopeTool::clearCurrentUserCache($userId);
```

### æ•°æ®æƒé™ç¤ºä¾‹

#### è‡ªå®šä¹‰æ•°æ®æƒé™ï¼ˆdata_scope=2ï¼‰

```php
// è§’è‰²é…ç½®
$role = Role::create([
    'name' => 'é¡¹ç›®ç®¡ç†å‘˜',
    'code' => 'project_manager',
    'data_scope' => 2, // è‡ªå®šä¹‰æƒé™
]);
$role->departments()->attach([1, 2, 3]); // é…ç½®å¯è®¿é—®çš„éƒ¨é—¨

// æ•°æ®æŸ¥è¯¢
$query = Project::query();
DataScopeTool::applyUserDataScope(0, $query);
// ç»“æœï¼šåªèƒ½è®¿é—®éƒ¨é—¨1ã€2ã€3ä¸‹ç”¨æˆ·åˆ›å»ºçš„é¡¹ç›®
```

#### æœ¬éƒ¨é—¨åŠä»¥ä¸‹æƒé™ï¼ˆdata_scope=4ï¼‰

```php
// ç”¨æˆ·é…ç½®ï¼šè®¾ç½®ç”¨æˆ·æ‰€å±çš„éƒ¨é—¨
$user->adminSetting->dept_id = [1]; // ç”¨æˆ·å±äºæŠ€æœ¯éƒ¨
$user->adminSetting->save();

// è§’è‰²é…ç½®
$role = Role::create([
    'name' => 'éƒ¨é—¨ç»ç†',
    'data_scope' => 4, // æœ¬éƒ¨é—¨åŠä»¥ä¸‹æƒé™
]);

// æ•°æ®æŸ¥è¯¢
$query = Task::query();
DataScopeTool::applyUserDataScope(0, $query);
// ç»“æœï¼šå¯ä»¥è®¿é—®æŠ€æœ¯éƒ¨åŠå…¶å­éƒ¨é—¨ä¸‹ç”¨æˆ·åˆ›å»ºçš„ä»»åŠ¡
```

## è¶…çº§ç®¡ç†å‘˜

æ‹¥æœ‰ `SuperAdmin` è§’è‰²ä»£ç çš„ç”¨æˆ·ä¸ºè¶…çº§ç®¡ç†å‘˜ï¼Œæ‹¥æœ‰ä»¥ä¸‹æƒé™ï¼š

- **åŠŸèƒ½æƒé™**ï¼šè·³è¿‡æ‰€æœ‰æƒé™æ£€æŸ¥ï¼Œæ‹¥æœ‰æ‰€æœ‰èœå•æƒé™
- **æ•°æ®æƒé™**ï¼šæ‹¥æœ‰å…¨éƒ¨æ•°æ®æƒé™ï¼ˆdata_scope=1ï¼‰ï¼Œå¯è®¿é—®æ‰€æœ‰æ•°æ®

### æ£€æŸ¥è¶…çº§ç®¡ç†å‘˜

```php
use App\Http\CurrentUser;

// Adminæ§åˆ¶å™¨
$user = $currentUser->adminUser();
$isSuperAdmin = $user->isSuperAdmin();

// æˆ–ç›´æ¥ä½¿ç”¨ CurrentUser çš„æ–¹æ³•
$isSuperAdmin = $currentUser->isSuperAdmin();
```

## API æ¥å£

### è·å–å½“å‰ç”¨æˆ·èœå•

**æ¥å£**ï¼š`GET /admin/permission/menus`

è·å–å½“å‰ç”¨æˆ·æœ‰æƒé™è®¿é—®çš„èœå•åˆ—è¡¨ï¼ˆæ ‘å½¢ç»“æ„ï¼‰

### è·å–å½“å‰ç”¨æˆ·è§’è‰²

**æ¥å£**ï¼š`GET /admin/permission/roles`

è·å–å½“å‰ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²åˆ—è¡¨

## ä»£ç ç¤ºä¾‹

### å®Œæ•´çš„æ§åˆ¶å™¨ç¤ºä¾‹

```php
use App\Http\Admin\Permission;
use App\Http\CurrentUser;
use App\Repository\ProjectRepository;
use Hyperf\HttpServer\Annotation\Middleware;
use App\Common\Middleware\AccessTokenMiddleware;
use App\Http\Admin\Middleware\PermissionMiddleware;

#[Middleware(middleware: AccessTokenMiddleware::class, priority: 100)]
#[Middleware(middleware: PermissionMiddleware::class, priority: 99)]
#[Permission(code: 'project.manage')]
class ProjectController extends AbstractController
{
    public function __construct(
        private readonly CurrentUser $currentUser,
        private readonly ProjectRepository $repository
    ) {}

    #[Permission(code: 'project.list')]
    public function list()
    {
        // è‡ªåŠ¨åº”ç”¨æ•°æ®æƒé™ï¼ˆåœ¨Repositoryçš„handleSearchä¸­ï¼‰
        $data = $this->repository->list($this->getRequestData());
        return $this->success($data);
    }

    #[Permission(code: 'project.create')]
    public function create(ProjectRequest $request)
    {
        $project = $this->repository->create(array_merge($request->validated(), [
            'created_by' => $this->currentUser->id(),
        ]));
        return $this->success($project);
    }
}
```

### å®Œæ•´çš„ Repository ç¤ºä¾‹

```php
use App\Http\Admin\Service\Permission\DataScopeTool;
use App\Model\Project;
use App\Repository\IRepository;

class ProjectRepository extends IRepository
{
    public function __construct(
        protected readonly Project $model
    ) {}

    public function handleSearch(Builder $query, array $params): Builder
    {
        // åº”ç”¨æ•°æ®æƒé™è¿‡æ»¤
        DataScopeTool::applyUserDataScope(0, $query);
        
        // å…¶ä»–æŸ¥è¯¢æ¡ä»¶
        if (isset($params['keyword'])) {
            $query->where('name', 'like', "%{$params['keyword']}%");
        }
        
        return $query;
    }
}
```

## æœ€ä½³å®è·µ

### æƒé™è®¾è®¡å»ºè®®

1. **èœå•å‘½åè§„èŒƒ**ï¼šä½¿ç”¨æ¨¡å—åŒ–å‘½åï¼Œå¦‚ `user.list`ã€`user.create`ã€`user.edit`
2. **æƒé™ç²’åº¦**ï¼šä¸ºæ¯ä¸ªåŠŸèƒ½ç‚¹é…ç½®ç‹¬ç«‹çš„æƒé™ç ï¼Œä¾¿äºç»†ç²’åº¦æ§åˆ¶
3. **è§’è‰²åˆ’åˆ†**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚åˆ›å»ºè§’è‰²ï¼Œé¿å…è§’è‰²è¿‡å¤šå¯¼è‡´ç®¡ç†å¤æ‚

### æ•°æ®æƒé™è®¾è®¡å»ºè®®

1. **æ•°æ®å½’å±**ï¼šç¡®ä¿æ‰€æœ‰æ•°æ®è¡¨éƒ½æœ‰ `created_by` å­—æ®µ
2. **éƒ¨é—¨é…ç½®**ï¼šæ­£ç¡®é…ç½®ç”¨æˆ·æ‰€å±çš„éƒ¨é—¨ï¼ˆ`user_admin_setting.dept_id`ï¼‰
3. **è§’è‰²é…ç½®**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚åˆç†è®¾ç½®è§’è‰²çš„ `data_scope`ï¼Œè‡ªå®šä¹‰æƒé™ï¼ˆdata_scope=2ï¼‰é€šè¿‡ `role_belongs_department` é…ç½®è§’è‰²å¯è®¿é—®çš„éƒ¨é—¨æ•°æ®æƒé™
4. **ç¼“å­˜ç®¡ç†**ï¼šè§’è‰²æˆ–éƒ¨é—¨å˜æ›´ååŠæ—¶æ¸…é™¤ç”¨æˆ·ç¼“å­˜

### æ€§èƒ½ä¼˜åŒ–

1. **æ‰¹é‡æŸ¥è¯¢**ï¼šç³»ç»Ÿå·²ä¼˜åŒ–å¤šè§’è‰²æƒé™æŸ¥è¯¢ï¼Œä½¿ç”¨æ‰¹é‡æŸ¥è¯¢é¿å…N+1é—®é¢˜
2. **ç¼“å­˜æœºåˆ¶**ï¼šç”¨æˆ·æƒé™ä¿¡æ¯ç¼“å­˜1å°æ—¶ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
3. **ç´¢å¼•ä¼˜åŒ–**ï¼šç¡®ä¿å…³è”è¡¨æœ‰é€‚å½“çš„ç´¢å¼•

## å¸¸è§é—®é¢˜

| é—®é¢˜ | è§£ç­” |
|------|------|
| ä¸ºä»€ä¹ˆç”¨æˆ·çœ‹ä¸åˆ°æŸäº›èœå•ï¼Ÿ | æ£€æŸ¥ï¼šç”¨æˆ·æ˜¯å¦æ‹¥æœ‰ç›¸å…³è§’è‰²ã€è§’è‰²æ˜¯å¦å…³è”äº†ç›¸åº”èœå•ã€èœå•å’Œè§’è‰²çŠ¶æ€æ˜¯å¦ä¸ºæ­£å¸¸ï¼ˆstatus=1ï¼‰ |
| ä¸ºä»€ä¹ˆæ•°æ®æƒé™ä¸ç”Ÿæ•ˆï¼Ÿ | æ£€æŸ¥ï¼šæ˜¯å¦è°ƒç”¨äº† `DataScopeTool::applyUserDataScope()`ã€æ•°æ®è¡¨æ˜¯å¦æœ‰ `created_by` å­—æ®µã€ç”¨æˆ·æ‰€å±éƒ¨é—¨é…ç½®æ˜¯å¦æ­£ç¡®ï¼ˆ`user_admin_setting.dept_id`ï¼‰ã€è§’è‰²çš„ `data_scope` æ˜¯å¦æ­£ç¡®é…ç½®ã€è‡ªå®šä¹‰æƒé™æ˜¯å¦é…ç½®äº† `role_belongs_department`ã€æ˜¯å¦æ¸…é™¤äº†ç”¨æˆ·ç¼“å­˜ |
| å¤šè§’è‰²æƒé™å¦‚ä½•åˆå¹¶ï¼Ÿ | åŠŸèƒ½æƒé™ï¼šå–å¹¶é›†ï¼ˆæ‰€æœ‰æ­£å¸¸çŠ¶æ€è§’è‰²çš„èœå•åˆå¹¶ï¼ŒæŒ‰èœå•IDå»é‡ï¼‰ï¼›æ•°æ®æƒé™ï¼šæŒ‰ä¼˜å…ˆçº§å–æœ€é«˜æƒé™ï¼›åªæœ‰çŠ¶æ€ä¸ºæ­£å¸¸ï¼ˆstatus=1ï¼‰çš„è§’è‰²æ‰ä¼šå‚ä¸æƒé™åˆ¤æ–­ |

## ä½¿ç”¨æµç¨‹

1. **é…ç½®è§’è‰²**ï¼šåˆ›å»ºè§’è‰²å¹¶è®¾ç½®æ•°æ®æƒé™èŒƒå›´ï¼ˆdata_scopeï¼‰
2. **é…ç½®èœå•**ï¼šåˆ›å»ºèœå•å¹¶è®¾ç½®æƒé™æ ‡è¯†ï¼ˆnameå­—æ®µï¼‰
3. **å…³è”æƒé™**ï¼šå°†èœå•åˆ†é…ç»™è§’è‰²ï¼ˆé€šè¿‡ role_belongs_menu è¡¨ï¼‰
4. **é…ç½®éƒ¨é—¨**ï¼ˆå¯é€‰ï¼‰ï¼šå¦‚æœè§’è‰²æ˜¯è‡ªå®šä¹‰æƒé™ï¼ˆdata_scope=2ï¼‰ï¼Œéœ€è¦é…ç½®è§’è‰²å¯è®¿é—®çš„éƒ¨é—¨æ•°æ®æƒé™ï¼ˆé€šè¿‡ role_belongs_department è¡¨ï¼‰
5. **åˆ†é…è§’è‰²**ï¼šå°†è§’è‰²åˆ†é…ç»™ç”¨æˆ·ï¼ˆé€šè¿‡ user_belongs_role è¡¨ï¼‰
6. **é…ç½®ç”¨æˆ·éƒ¨é—¨**ï¼šè®¾ç½®ç”¨æˆ·æ‰€å±çš„éƒ¨é—¨ï¼ˆuser_admin_setting.dept_idï¼‰
7. **åº”ç”¨æƒé™**ï¼šåœ¨æ§åˆ¶å™¨ä½¿ç”¨ `@Permission` æ³¨è§£ï¼Œåœ¨ Repository ä½¿ç”¨ `DataScopeTool`

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®è¡¨è¦æ±‚**ï¼šç¡®ä¿æ‰€æœ‰éœ€è¦æ•°æ®æƒé™æ§åˆ¶çš„æ•°æ®è¡¨éƒ½æœ‰ `created_by` å­—æ®µ
2. **ç”¨æˆ·éƒ¨é—¨é…ç½®**ï¼šæ­£ç¡®é…ç½®ç”¨æˆ·æ‰€å±çš„éƒ¨é—¨ï¼ˆ`user_admin_setting.dept_id`ï¼ŒJSONæ•°ç»„æ ¼å¼ï¼‰
3. **è§’è‰²éƒ¨é—¨é…ç½®**ï¼šè‡ªå®šä¹‰æƒé™ï¼ˆdata_scope=2ï¼‰é€šè¿‡ `role_belongs_department` è¡¨é…ç½®è§’è‰²å¯è®¿é—®çš„éƒ¨é—¨æ•°æ®æƒé™
4. **è§’è‰²çŠ¶æ€**ï¼šåªæœ‰æ­£å¸¸çŠ¶æ€ï¼ˆstatus=1ï¼‰çš„è§’è‰²æ‰ä¼šå‚ä¸æƒé™åˆ¤æ–­
5. **èœå•çŠ¶æ€**ï¼šåªæœ‰æ­£å¸¸çŠ¶æ€ï¼ˆstatus=1ï¼‰çš„èœå•æ‰ä¼šè¢«è¿”å›
6. **ç¼“å­˜ç®¡ç†**ï¼šè§’è‰²æˆ–éƒ¨é—¨å˜æ›´ååŠæ—¶æ¸…é™¤ç”¨æˆ·ç¼“å­˜ï¼ˆ`DataScopeTool::clearCurrentUserCache($userId)`ï¼‰
7. **æƒé™æ³¨è§£**ï¼šä½¿ç”¨æƒé™æ³¨è§£æ—¶æ³¨æ„æ“ä½œç¬¦çš„é€‰æ‹©ï¼ˆAND/ORï¼‰
8. **è¶…çº§ç®¡ç†å‘˜**ï¼šæ‹¥æœ‰ `SuperAdmin` è§’è‰²ä»£ç çš„ç”¨æˆ·è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼Œè·³è¿‡æƒé™æ£€æŸ¥

