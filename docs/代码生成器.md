# 代码生成器使用指南

## 快速开始

### 基本命令

```bash
# 生成CRUD代码
php bin/hyperf.php ds:crud --table=users --module=admin

# 强制覆盖
php bin/hyperf.php ds:crud --table=users --module=admin --force=true

# 插件模式
php bin/hyperf.php ds:crud --table=articles --module=admin --plugin=ds/article

# API模式（只生成PHP代码）
php bin/hyperf.php ds:crud --table=users --module=api --target=api

# 自动执行SQL
php bin/hyperf.php ds:crud --table=users --module=admin --sql=true
```

### 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--table` | 数据库表名（不含前缀） | 必填 |
| `--module` | 模块名称，对应前端目录结构 | 必填 |
| `--force` | 是否强制覆盖现有文件 | false |
| `--pid` | 父级菜单ID，用于菜单层级关系 | 0 |
| `--sql` | 是否自动执行SQL插入菜单数据 | false |
| `--plugin` | 插件目录路径 | - |
| `--target` | 目标目录类型：`admin`（默认）、`api` | admin |

⚠️ **注意**：`--sql=true` 仅支持非插件模式，插件模式请手动执行生成的SQL文件。

## Target 模式说明

| 模式 | 后端代码 | 前端代码 | 菜单SQL | 使用场景 |
|------|---------|---------|---------|---------|
| **admin**（默认） | ✅ | ✅ | ✅ | 后台管理系统 |
| **api** | ✅ | ❌ | ✅ | 纯API接口、移动端后端服务 |

**中间件差异**：
- **admin模式**：`AccessTokenMiddleware` + `PermissionMiddleware` + `OperationMiddleware`
- **api模式**：`TokenMiddleware`（JWT Token 验证）

## 生成的文件结构

### 后端文件

| 模式 | 路径 |
|------|------|
| **Admin** | `app/Http/Admin/{Controller,Request,Service}/{Module}/` |
| **Api** | `app/Http/Api/{Controller,Request,Service}/{Module}/` |
| **插件** | `plugin/{org}/{plugin}/src/Http/{Admin\|Api}/{Controller,Request,Service}/` |

### 前端文件（仅 Admin 模式）

```
web/src/modules/{module}/
├── api/                                    # API接口定义
├── views/{tableName}/                      # 页面组件
│   ├── data/                              # 数据配置
│   │   ├── getFormItems.tsx               # 表单配置
│   │   ├── getTableColumns.tsx            # 表格列配置
│   │   └── getSearchItems.tsx             # 搜索配置
│   ├── form.vue                           # 表单组件
│   └── index.vue                          # 列表页面
└── locales/                               # 多语言文件
```

### SQL 文件

```
runtime/sql/{ModelName}Menu.sql
```

包含主菜单项和权限菜单项（list、create、save、delete）。默认只生成文件，不自动执行。

## deleteById 方法说明

代码生成器生成的Controller中，`delete()` 方法调用 `deleteById($this->getRequestData(), [])`，第二个参数 `$where` 用于额外的条件过滤（如数据权限）。

**方法签名**：
```php
public function deleteById(mixed $id, array $where = []): int
```

**参数说明**：
- `$id`: 要删除的ID（支持单个ID或ID数组），通常使用 `$this->getRequestData()` 获取请求体数组
- `$where`: 额外的where条件数组（可选），用于数据权限过滤等场景

**使用示例**：
```php
// 基本删除（请求体直接是数组：[1, 2, 3]）
$this->service->deleteById($this->getRequestData(), []);

// 带数据权限过滤的删除
$this->service->deleteById($this->getRequestData(), ['created_by' => $userId]);
```

**Swagger 请求参数配置**：

```php
#[Delete(path: '/api/{模块名}/delete', summary: '删除', tags: ['{模块名}'])]
#[RequestBody(
    content: new JsonContent(
        type: 'array',
        items: new OA\Items(type: 'integer'),
        example: '[1, 2, 3]'
    )
)]
public function delete(): Result
{
    $this->service->deleteById($this->getRequestData(), []);
    return $this->success();
}
```

**请求格式**：
- ✅ 正确：`[1, 2, 3]` （直接数组）
- ❌ 错误：`{"ids": [1, 2, 3]}` （对象格式）

## 字段映射规则

### 组件类型自动识别

代码生成器会根据字段名自动识别组件类型，匹配优先级：**后缀匹配 > 前缀匹配 > 包含匹配**

#### 后缀匹配（字段以指定后缀结尾）

| 字段后缀 | 组件类型 | 示例 |
|---------|---------|------|
| `_enabled`, `_disabled`, `_is_` | `el-switch` | `is_enabled`, `user_disabled` |
| `_image`, `_cover`, `_img`, `_photo`, `_avatar`, `_logo` | `ma-upload-image` | `cover_image`, `user_avatar` |
| `_file`, `_attachment` | `ma-upload-file` | `attachment_file` |
| `_time`, `_date`, `_datetime`, `_at` | `el-date-picker` | `created_at`, `publish_date` |
| `_content`, `_body`, `_text`, `_html` | `el-editor` | `article_content` |
| `_price`, `_amount`, `_qty`, `_count`, `_number`, `_num` | `el-input-number` | `product_price`, `order_amount` |
| `_type`, `_category`, `_level`, `_role`, `_permission`, `_status`, `_state`, `_flag`, `_id` | `el-select` | `user_type`, `order_status`, `category_id` |
| `_color` | `el-color-picker` | `theme_color` |
| `_rate`, `_rating` | `el-rate` | `product_rating` |

#### 前缀匹配（字段以指定前缀开头）

| 字段前缀 | 组件类型 | 示例 |
|---------|---------|------|
| `is_`, `has_`, `can_` | `el-switch` | `is_enabled`, `has_permission`, `can_edit` |

#### 包含匹配（字段名包含指定字符串）

| 包含字符串 | 组件类型 | 示例 |
|---------|---------|------|
| `password`, `email`, `phone`, `mobile`, `url` | `el-input` | `user_email`, `user_phone` |
| `color` | `el-color-picker` | `theme_color` |
| `attr`, `type`, `category`, `level`, `role`, `permission`, `status`, `state`, `flag` | `el-select` | `user_type`, `order_status` |
| `logo`, `avatar`, `image`, `img`, `cover`, `icon`, `photo` | `ma-upload-image` | `user_avatar`, `cover_image` |
| `file`, `attachment` | `ma-upload-file` | `attachment_file` |
| `content`, `body`, `text`, `html` | `el-editor` | `article_content` |

### 验证规则自动生成

| 规则类型 | 生成规则 |
|---------|---------|
| **数据库类型** | 整数→`integer`，小数→`numeric`，日期→`date`，JSON→`array`，布尔→`boolean` |
| **字段名称** | 邮箱→`email`，密码→`min:6\|confirmed`，电话→`regex:/^1[3456789]\d{9}$/`，IP→`ip`，价格→`numeric\|min:0` |
| **必填字段** | 通过字段注释中的 `[required]` 标记生成 `required`，否则使用 `sometimes` |

## 数据库表设计规范

### 字段注释格式

```sql
-- 基础格式：字段说明[规则1,规则2,...]
username VARCHAR(50) COMMENT '用户名[required,search]'
status TINYINT COMMENT '状态[required] 0=禁用,1=启用'

-- 支持的规则：
-- required: 必填字段
-- search: 可搜索字段
-- hidden: 隐藏字段（不显示在列表和表单中）
```

### 字段自动过滤规则

代码生成器会自动过滤以下系统字段，无需手动配置：

**表单字段过滤（不参与表单生成）**：
- `id` - 主键ID（自动生成）
- `created_at` - 创建时间（自动生成）
- `updated_at` - 更新时间（自动更新）
- `deleted_at` - 删除时间（软删除）
- `created_by` - 创建人（自动填充）
- `updated_by` - 更新人（自动填充）

**表格字段过滤（不参与表格显示）**：
- `created_at` - 创建时间
- `updated_at` - 更新时间
- `created_by` - 创建人
- `updated_by` - 更新人
- `remark` - 备注（通常不在列表显示）

**大文本类型字段（不参与列表显示）**：
- `text`, `mediumtext`, `longtext` - 文本类型
- `blob`, `mediumblob`, `longblob` - 二进制类型
- `json`, `jsonb` - JSON类型
- 包含 `description`, `content` 的字段名

**其他自动过滤**：
- 包含 `password` 的字段（安全考虑）
- 包含 `deleted_at` 的字段（软删除标记）

### 枚举值配置

```sql
status TINYINT COMMENT '状态 0=禁用,1=启用,2=待审核'
```

## 自定义配置

### JSON 配置文件

代码生成器会在 `runtime/json/` 目录生成配置文件（`{tableName}.json`），可手动修改后重新生成：

```json
{
  "searchFields": ["username", "status"],
  "tableFields": ["id", "username", "email", "status"],
  "sortFields": ["id", "created_at"],
  "formFields": [
    {
      "prop": "username",
      "label": "用户名",
      "render": "<el-input />",
      "requestRule": ["required"],
      "renderProps": {
        "placeholder": "t('form.pleaseInput', { msg: '用户名' })"
      }
    }
  ]
}
```

**字段说明**：
- `searchFields`: 可搜索的字段列表
- `tableFields`: 表格显示的字段列表（默认包含 `id`）
- `sortFields`: 可排序的字段列表
- `formFields`: 表单字段配置数组
  - `prop`: 字段名
  - `label`: 字段标签
  - `render`: 渲染组件
  - `requestRule`: 验证规则数组
  - `renderProps`: 组件属性配置

### 模板自定义

模板文件位于 `app/Command/Generator/stub/`：

| 类型 | 模板文件 |
|------|---------|
| **后端** | `controller.blade.stub`, `model.blade.stub`, `service.blade.stub`, `request.blade.stub`, `repository.blade.stub`, `sql.blade.stub` |
| **前端** | `frontend/index-vue.blade.stub`, `frontend/form-vue.blade.stub`, `frontend/api-ts.blade.stub`, `frontend/getFormItems-tsx.blade.stub`, `frontend/getTableColumns-tsx.blade.stub`, `frontend/getSearchItems-tsx.blade.stub` |

## 高级功能

### 自动菜单生成

自动生成菜单 SQL 文件（`runtime/sql/{ModelName}Menu.sql`），包含：
- 主菜单项
- 列表权限（list）
- 新增权限（create）
- 编辑权限（save）
- 删除权限（delete）

**执行方式**：
- **默认模式**（推荐）：只生成 SQL 文件，不自动执行
- **自动执行模式**：使用 `--sql=true` 参数（仅非插件模式）

**手动执行 SQL**：
```bash
mysql -u用户名 -p数据库名 < runtime/sql/UserMenu.sql
```

### 多语言支持

自动生成中英文多语言文件（字段标签、按钮文本、提示信息）。

### 操作日志

集成操作日志中间件，自动记录 CRUD 操作。

## 最佳实践

1. **表设计规范**：使用有意义的字段名，合理设置字段注释和枚举值
2. **模块规划**：按业务功能划分模块，模块名称使用英文小写
3. **权限控制**：合理设置菜单层级关系，配置适当的权限代码
4. **代码优化**：生成后检查生成的代码，根据需要调整组件配置和业务逻辑
5. **Model类型声明**：⚠️ 代码生成器生成的Model只有PHPDoc注释（`@property`），没有类属性类型声明，如需类型提示，请手动添加类属性类型声明

## 故障排除

| 问题 | 解决方案 |
|------|---------|
| 表不存在错误 | 检查表名是否正确，确认数据库连接配置 |
| 文件已存在错误 | 使用 `--force=true` 参数覆盖，或手动删除已存在的文件 |
| 模板渲染错误 | 检查模板语法是否正确，确认模板文件是否存在 |
| 权限配置问题 | 检查菜单表结构，确认权限中间件配置 |
| SQL 执行问题 | 默认只生成 SQL 文件，使用 `--sql=true` 自动执行（仅非插件模式） |
| Model缺少类型声明 | 代码生成器只生成PHPDoc注释，如需类型提示请手动添加类属性类型声明 |

### 调试技巧

1. 查看生成日志了解详细过程
2. 检查 `runtime/json/` 目录的配置文件
3. 使用 `--force=true` 重新生成
4. 检查 `runtime/sql/` 目录的 SQL 文件内容
5. 手动执行生成的 SQL 文件（默认不自动执行）
