# 数据库迁移工具使用指南

FastApp 提供了三个数据库迁移工具命令，用于生成和导入数据库迁移文件和数据文件。

## 命令概览

| 命令 | 别名 | 功能 | 输出文件 |
|------|------|------|---------|
| `ds:generate-migrations` | `ds:gen-migrations` | 从现有数据库表生成迁移文件 | PHP迁移文件 |
| `ds:generate-seeders` | `ds:gen-seeders` | 从现有数据库表数据生成Seeder文件 | SQL文件 |
| `ds:import-sql` | `ds:import` | 导入SQL文件到数据库 | - |

## 1. 生成迁移文件 (ds:generate-migrations)

从现有数据库表结构生成迁移文件，自动过滤插件表，合并到一个文件。

### 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--force` | 是否强制覆盖已存在的文件 | false |
| `--prefix` | 数据库表前缀 | 从环境变量 `DB_PREFIX` 读取 |
| `--filename` | 生成的文件名 | all_tables |

### 使用示例

```bash
# 基本使用
php bin/hyperf.php ds:generate-migrations

# 指定文件名并强制覆盖
php bin/hyperf.php ds:generate-migrations --filename=production --force=true

# 指定表前缀
php bin/hyperf.php ds:generate-migrations --prefix=app_
```

### 功能特性

- ✅ 自动过滤插件表，只生成非插件表的迁移文件
- ✅ 合并到一个文件，包含完整表结构（字段、索引、注释等）
- ✅ 智能类型转换，自动识别字段类型

### 输出文件

生成位置：`databases/migrations/YYYY_MM_DD_HHMMSS_{filename}.php`

## 2. 生成Seeder文件 (ds:generate-seeders)

从现有数据库表数据生成Seeder文件，过滤插件表，合并到一个文件，支持自动分片。

### 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--force` | 是否强制覆盖已存在的文件 | false |
| `--prefix` | 数据库表前缀 | 从环境变量 `DB_PREFIX` 读取 |
| `--filename` | 生成的文件名 | all_data |
| `--limit` | 每个表最多导出的记录数 | 1000 |
| `--chunk-size` | 分片文件大小（MB） | 10 |

### 使用示例

```bash
# 基本使用
php bin/hyperf.php ds:generate-seeders

# 限制记录数并设置分片大小
php bin/hyperf.php ds:generate-seeders --limit=5000 --chunk-size=50

# 指定文件名
php bin/hyperf.php ds:generate-seeders --filename=backup
```

### 功能特性

- ✅ 自动过滤插件表，只生成非插件表的数据
- ✅ 自动分片，当文件超过指定大小时自动分割
- ✅ 批量插入，每批100条记录，自动转义SQL特殊字符
- ✅ 显示导出进度和文件大小

### 输出文件

生成位置：`databases/seeders/YYYY_MM_DD_HHMMSS_{filename}.sql`

如果文件过大，会自动分片：`{filename}_part2.sql`、`_part3.sql` 等

## 3. 导入SQL文件 (ds:import-sql)

导入SQL文件到数据库，支持分片文件自动识别。

### 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `file` | SQL文件路径（必需，支持相对/绝对路径） | - |
| `--skip-errors` | 是否跳过错误继续执行 | false |
| `--transaction` | 是否使用事务执行 | true |
| `--batch-size` | 批量显示进度的语句数 | 100 |

### 使用示例

```bash
# 基本使用（相对路径，相对于 databases/seeders 目录）
php bin/hyperf.php ds:import-sql 2025_11_08_070209_all_data.sql

# 绝对路径
php bin/hyperf.php ds:import-sql /path/to/file.sql

# 跳过错误继续执行
php bin/hyperf.php ds:import-sql file.sql --skip-errors=true

# 不使用事务（大数据量导入可提高性能）
php bin/hyperf.php ds:import-sql file.sql --transaction=false
```

### 功能特性

- ✅ 自动识别分片文件（`file_part2.sql` 等），按顺序导入
- ✅ 支持目录导入，自动导入目录下所有SQL文件
- ✅ 智能SQL分割，正确处理字符串中的分号
- ✅ 自动移除SQL注释，显示导入进度和统计信息

### 路径支持

- **相对路径**：相对于 `databases/seeders/` 目录
- **绝对路径**：直接指定完整路径
- **目录路径**：导入目录下所有SQL文件

## 工作流程示例

### 备份和恢复数据库

```bash
# 1. 生成表结构迁移文件
php bin/hyperf.php ds:generate-migrations --filename=production_tables

# 2. 生成数据文件
php bin/hyperf.php ds:generate-seeders --filename=production_data --limit=10000 --chunk-size=50

# 3. 在新环境导入
php bin/hyperf.php migrate
php bin/hyperf.php ds:import-sql 2025_11_08_070209_production_data.sql
```

### 开发环境数据同步

```bash
# 导出限制数量的数据
php bin/hyperf.php ds:generate-seeders --limit=100 --filename=dev_data

# 导入（跳过错误）
php bin/hyperf.php ds:import-sql dev_data.sql --skip-errors=true
```

## 常见问题

| 问题 | 解答 |
|------|------|
| 为什么生成的迁移文件不包含插件表？ | 这是设计特性，命令会自动扫描 `plugin/` 目录并过滤插件表，插件表的迁移文件由插件自己管理 |
| 如何导出所有数据？ | 设置一个很大的值，如 `--limit=999999` |
| 导入时遇到错误怎么办？ | 事务模式（默认）会回滚所有操作；使用 `--skip-errors=true` 会跳过错误继续执行 |
| 分片文件如何命名？ | `{原文件名}_part{序号}.sql`，如 `file_part2.sql`、`file_part3.sql` |

## 最佳实践

1. **定期备份**：使用 `ds:generate-seeders` 定期生成数据备份
2. **版本控制**：迁移文件纳入版本控制，数据文件使用 `.gitignore` 忽略
3. **测试导入**：生产环境导入前，先在测试环境验证
4. **分片管理**：大数据量合理设置 `--chunk-size`，避免单个文件过大
5. **错误处理**：生产环境使用事务模式，确保数据一致性

---

*最后更新：2025-11-08*