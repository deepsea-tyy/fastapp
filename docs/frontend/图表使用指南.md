# 图表使用指南

本文档介绍 FastApp 前端框架的图表系统使用方法，基于 Apache ECharts 封装。

## 一、图表组件 (useEcharts)

### 1.1 基础使用

`useEcharts` 是基于 ECharts 封装的 Hook，提供简洁的图表创建和管理方式。

```vue
<template>
  <div ref="chartRef" class="h-[400px]" />
</template>

<script setup lang="ts">
import { useEcharts } from '@/hooks/useEcharts'

const chartRef = ref<HTMLElement>()
const { setOption } = useEcharts(chartRef)

const chartOption = {
  title: { text: '示例图表' },
  xAxis: {
    type: 'category',
    data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
  },
  yAxis: { type: 'value' },
  series: [{
    data: [120, 200, 150, 80, 70, 110, 130],
    type: 'bar',
  }],
}

setOption(chartOption)
</script>
```

### 1.2 Hook 返回值

| 方法/属性 | 说明 |
|---------|------|
| `setOption` | 设置图表配置 |
| `showLoading` / `hideLoading` | 显示/隐藏加载动画 |
| `clear` | 清空图表 |
| `resize` | 调整图表大小 |
| `appendData` | 追加数据 |
| `getOption` | 获取当前配置 |

### 1.3 配置选项

```typescript
const { setOption } = useEcharts(chartRef, {
  theme: 'mineDark',        // 主题：'default' | 'light' | 'mineDark'
  renderer: 'canvas',       // 渲染模式：'canvas' | 'svg'
  devicePixelRatio: 2,      // 设备像素比
})
```

## 二、支持的图表类型

### 2.1 已注册的图表类型

**图表类型**：`LineChart`（折线图）、`BarChart`（柱状图）、`PieChart`（饼图）、`RadarChart`（雷达图）

**组件**：`GridComponent`、`TitleComponent`、`LegendComponent`、`TooltipComponent`、`ToolboxComponent`、`DataZoomComponent`、`VisualMapComponent`、`GraphicComponent`、`PolarComponent`

### 2.2 使用其他图表类型

如需使用其他图表类型（如散点图、地图等），需要在 `web/src/provider/echarts/index.ts` 中注册：

```typescript
import { ScatterChart, MapChart } from 'echarts/charts'

use([
  // ... 已有图表
  ScatterChart,
  MapChart,
])
```

## 三、常用图表示例

### 3.1 折线图

```typescript
const option = {
  title: { text: '折线图示例' },
  tooltip: { trigger: 'axis' },
  xAxis: {
    type: 'category',
    data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
  },
  yAxis: { type: 'value' },
  series: [{
    name: '销量',
    type: 'line',
    data: [120, 200, 150, 80, 70, 110, 130],
    smooth: true,
  }],
}
```

### 3.2 柱状图

```typescript
const option = {
  title: { text: '柱状图示例' },
  tooltip: { trigger: 'axis' },
  xAxis: {
    type: 'category',
    data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
  },
  yAxis: { type: 'value' },
  series: [{
    name: '销量',
    type: 'bar',
    data: [120, 200, 150, 80, 70, 110, 130],
    itemStyle: { color: '#409EFF' },
  }],
}
```

### 3.3 饼图

```typescript
const option = {
  title: { text: '饼图示例' },
  tooltip: { trigger: 'item' },
  series: [{
    name: '访问来源',
    type: 'pie',
    radius: '50%',
    data: [
      { value: 1048, name: '搜索引擎' },
      { value: 735, name: '直接访问' },
      { value: 580, name: '邮件营销' },
    ],
  }],
}
```

## 四、主题配置

### 4.1 内置主题

- `default` - 默认主题（浅色）
- `light` - 浅色主题
- `mineDark` - 深色主题

### 4.2 使用主题

```typescript
// 方式一：通过 Hook 配置
const { setOption } = useEcharts(chartRef, {
  theme: 'mineDark',
})

// 方式二：响应式主题（自动跟随系统主题）
import { useEcharts, themeMode } from '@/hooks/useEcharts'

const { setOption } = useEcharts(chartRef, {
  theme: computed(() => themeMode()),
})
```

### 4.3 自定义主题

1. 访问 [ECharts 主题构建器](https://echarts.apache.org/zh/theme-builder.html) 创建主题
2. 在 `web/src/provider/echarts/index.ts` 中注册：
   ```typescript
   import customTheme from './themes/custom-theme.json'
   echarts.registerTheme('customTheme', customTheme.theme)
   ```
3. 使用：`useEcharts(chartRef, { theme: 'customTheme' })`

## 五、响应式处理

### 5.1 自动调整大小

图表容器大小变化时，需要调用 `resize()` 方法：

```typescript
import { useWindowSize } from '@vueuse/core'

const { resize } = useEcharts(chartRef)
const { width, height } = useWindowSize()

watch([width, height], () => {
  resize()
})
```

### 5.2 响应式配置

```typescript
const chartOption = computed(() => ({
  grid: {
    left: isMobile.value ? '10%' : '3%',
    right: isMobile.value ? '10%' : '4%',
  },
  // ... 其他配置
}))
```

## 六、数据更新

### 6.1 更新图表数据

```typescript
const chartData = ref([120, 200, 150, 80, 70, 110, 130])
const { setOption } = useEcharts(chartRef)

const option = computed(() => ({
  series: [{ data: chartData.value, type: 'line' }],
}))

watch(chartData, () => {
  setOption(option.value)
}, { deep: true })
```

### 6.2 追加数据

```typescript
const { appendData } = useEcharts(chartRef)

appendData({
  seriesIndex: 0,
  data: [140, 160],
})
```

## 七、加载状态

```typescript
const { showLoading, hideLoading } = useEcharts(chartRef)

showLoading({ text: '加载中...', color: '#409EFF' })
await loadData()
hideLoading()
```

## 八、事件处理

```typescript
const { setOption } = useEcharts(chartRef)

setOption(option, [
  {
    name: 'click',
    callback: (params) => {
      console.log('点击了图表', params)
    },
  },
  {
    name: 'legendselectchanged',
    callback: (params) => {
      console.log('图例选择变化', params)
    },
  },
])
```

**常用事件**：`click`、`dblclick`、`mousemove`、`mouseover`、`legendselectchanged`、`datazoom`

## 九、完整示例

```vue
<template>
  <div ref="chartRef" class="h-[400px]" />
</template>

<script setup lang="ts">
import { useEcharts, themeMode } from '@/hooks/useEcharts'
import { useWindowSize } from '@vueuse/core'

const chartRef = ref<HTMLElement>()
const { setOption, resize } = useEcharts(chartRef, {
  theme: computed(() => themeMode()),
})

const chartData = ref([120, 200, 150, 80, 70, 110, 130])

const option = computed(() => ({
  title: { text: '动态数据图表' },
  xAxis: {
    type: 'category',
    data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
  },
  yAxis: { type: 'value' },
  series: [{
    type: 'line',
    data: chartData.value,
  }],
}))

setOption(option.value)

// 响应式调整
const { width, height } = useWindowSize()
watch([width, height], () => resize())
</script>
```

## 十、最佳实践

- ✅ 使用 `computed` 创建配置，避免不必要的重新渲染
- ✅ 大数据量时使用 `dataZoom` 进行数据缩放
- ✅ 使用 `appendData` 追加数据，而不是重新设置整个配置
- ✅ 图表容器使用固定高度，避免频繁 resize
- ✅ 使用响应式主题，自动适配深色/浅色模式
- ✅ 监听窗口大小变化，及时调用 `resize()`

## 十一、常见问题

**Q1: 图表不显示？**  
确保容器有明确的高度（如 `h-[400px]`），检查 `chartRef` 是否正确绑定。

**Q2: 图表大小不正确？**  
容器大小变化后调用 `resize()` 方法，使用固定高度而非百分比高度。

**Q3: 如何切换主题？**  
使用 `themeMode()` 获取当前主题，通过 `useEcharts` 的配置选项设置主题。

**Q4: 如何更新图表数据？**  
使用 `setOption()` 更新配置，或使用 `appendData()` 追加数据。

**Q5: 图表在弹窗中显示异常？**  
弹窗打开后调用 `resize()` 方法，使用 `nextTick` 确保 DOM 已渲染。

**Q6: 如何添加自定义图表类型？**  
在 `web/src/provider/echarts/index.ts` 中导入并注册，参考 ECharts 官方文档。

**Q7: 图表性能问题？**  
大数据量时使用数据采样，使用 `dataZoom` 进行数据缩放，考虑使用 Canvas 渲染模式。
