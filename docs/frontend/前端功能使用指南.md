# 前端功能使用指南

本文档介绍 FastApp 前端框架的核心功能使用方法。

## 一、组件命名规范

| 组件类型 | 命名前缀 | 示例 | 说明 |
|---------|---------|------|------|
| **基础 UI 组件** | `m-` | `m-button`, `m-input`, `m-drawer` | 轻量级基础组件，无业务逻辑，全局自动注册 |
| **业务组件** | `ma-` | `ma-table`, `ma-form`, `ma-drawer` | 包含业务逻辑，基于 Element Plus 封装 |

**基础组件**：`m-button`, `m-input`, `m-textarea`, `m-switch`, `m-tooltip`, `m-dropdown`, `m-tabs`, `m-modal`, `m-drawer`

**常用业务组件**：`ma-table`, `ma-pro-table`, `ma-form`, `ma-search`, `ma-drawer`, `ma-dialog`, `ma-upload-*`, `ma-dict-*`

**选择建议**：
- `m-xx`：轻量级基础 UI、高度自定义、简单界面
- `ma-xx`：完整业务功能、集成搜索/分页、API 交互

## 二、响应式布局

### 2.1 响应式断点

| 断点 | 宽度范围 | 设备类型 |
|------|---------|---------|
| **xs** | < 768px | 移动端 |
| **sm** | 768px - 992px | 平板 |
| **md** | 992px - 1200px | 中等屏幕 |
| **lg** | 1200px - 1920px | 大屏幕 |
| **xl** | ≥ 1920px | 超大屏幕 |

**移动端判断**：`useSettingStore().getMobileState()`（< 1024px 返回 true）

### 2.2 表单响应式

```typescript
useFormResponsive(formRef, {
  xsLabelPosition: 'top',    // 小屏：标签在上方
  lgLabelPosition: 'right', // 大屏：标签在右侧
})
```

### 2.3 抽屉响应式宽度

```typescript
const { Drawer, open } = useDrawer({
  xsSize: '90%',  // 小屏
  lgSize: '50%',  // 大屏
})
```

## 三、文件上传

### 3.1 视频上传

```vue
<ma-upload-video
  v-model="videoUrl"
  :file-size="100 * 1024 * 1024"
  :file-type="['mp4', 'avi', 'mov']"
/>
```

### 3.2 分片上传

```typescript
import { chunkUpload, shouldUseChunkUpload } from '@/utils/chunkUpload'

if (shouldUseChunkUpload(file, 10 * 1024 * 1024)) {
  const result = await chunkUpload({
    file,
    chunkSize: 2 * 1024 * 1024,
    onProgress: (progress) => console.log(`进度: ${progress}%`)
  })
}
```

**流程**：计算MD5 → 文件分片 → 并发上传 → 合并分片 → 返回URL

**后端接口**：`POST /attachment/chunk-upload`（上传分片）、`POST /attachment/chunk-merge`（合并分片）

### 3.3 普通文件上传

```typescript
import { uploadLocal } from '@/utils/uploadLocal'
const result = await uploadLocal({ file }, '/custom/upload', 'customFile')
```

## 四、字典数据

### 4.1 字典操作

```typescript
const dictStore = useDictStore()
dictStore.find('role-dataScope')           // 查找字典
dictStore.t('role-dataScope', 1, 'label')  // 翻译字典值
```

### 4.2 字典组件

```vue
<ma-dict-select v-model="value" dict-name="role-dataScope" />
<ma-dict-radio v-model="value" dict-name="role-dataScope" render-mode="button" />
<ma-dict-checkbox v-model="values" dict-name="role-dataScope" />
```

### 4.3 字典定义

在 `web/src/provider/dictionary/data/` 或插件 `web/dictionary/` 目录创建：

```typescript
export default [
  { label: '选项1', value: 1, i18n: 'dict.option1', color: 'primary' },
] as Dictionary[]
```

**命名规则**：文件名即为字典名称，应用启动时自动加载

## 五、表单组件 (ma-form)

### 5.1 基础使用

```vue
<template>
  <ma-form ref="formRef" v-model="formData" />
</template>

<script setup lang="ts">
import type { MaFormExpose } from '@/components/ma-form'
import useForm from '@/hooks/useForm'

const formRef = ref<MaFormExpose>()
const formData = ref({})

useForm('formRef').then((form: MaFormExpose) => {
  form.setItems([
    {
      label: '用户名',
      prop: 'username',
      render: 'input',
      renderProps: { placeholder: '请输入用户名' },
      itemProps: { rules: [{ required: true, message: '请输入用户名' }] },
    },
  ])
})
</script>
```

### 5.2 表单项配置

| 属性 | 类型 | 说明 |
|------|------|------|
| `label` | `string \| () => string` | 标签文本 |
| `prop` | `string` | 表单字段名 |
| `render` | `string \| Component \| () => Component` | 渲染组件：`'input'`、`() => MaDictSelect` |
| `renderProps` | `Record<string, any>` | 组件属性 |
| `itemProps` | `FormItem` | Element Plus FormItem 属性（rules 等） |
| `cols` | `object` | 响应式布局：`{ md: 12, xs: 24 }` |
| `hide` | `boolean \| (item, model) => boolean` | 隐藏条件 |
| `show` | `boolean \| (item, model) => boolean` | 显示条件 |

### 5.3 条件渲染

```typescript
// 方式一：使用 hide 或 show
{
  label: '密码',
  prop: 'password',
  render: 'input',
  hide: (item, model) => formType === 'edit', // 编辑时隐藏
}

{
  label: '管理员权限',
  prop: 'adminPermission',
  render: 'input',
  show: (item, model) => model.userType === 1, // 仅管理员显示
}

// 方式二：动态控制
const formItems = computed(() => [
  { label: '用户名', prop: 'username', render: 'input' },
  ...(formData.value.userType === 1 ? [
    { label: '管理员权限', prop: 'adminPermission', render: 'input' },
  ] : []),
])
```

### 5.4 响应式布局

```typescript
{
  label: '用户名',
  prop: 'username',
  render: 'input',
  cols: {
    xs: 24,  // 移动端：占满整行
    md: 12,  // 中等屏幕：占一半
    lg: 8,   // 大屏：占 1/3
  },
}
```

### 5.5 常用组件渲染

**Element Plus 内置**：`'input'`, `'textarea'`, `'select'`, `'datePicker'`, `'switch'`, `'radio'`, `'checkbox'`

**自定义组件**：
```typescript
{
  label: '状态',
  prop: 'status',
  render: () => MaDictSelect,
  renderProps: { dictName: 'system-status' },
}
```

### 5.6 表单方法

```typescript
formRef.value.setItems(formItems)              // 设置表单项
formRef.value.setOptions({ labelWidth: '100px' }) // 设置配置
formRef.value.validate()                       // 表单验证
formRef.value.resetFields()                    // 重置表单
formRef.value.clearValidate()                  // 清除验证
formRef.value.getFormData()                    // 获取表单数据
```

### 5.7 表单验证

```typescript
{
  label: '邮箱',
  prop: 'email',
  render: 'input',
  itemProps: {
    rules: [
      { required: true, message: '请输入邮箱' },
      { type: 'email', message: '请输入正确的邮箱格式' },
      {
        validator: (rule, value, callback) => {
          value && !value.includes('@') 
            ? callback(new Error('邮箱格式不正确'))
            : callback()
        },
      },
    ],
  },
}
```

## 六、表格组件

### 6.1 MaProTable 高级表格

集成搜索、分页、操作的完整表格组件：

```vue
<template>
  <MaProTable ref="proTableRef" :options="options" :schema="schema" />
</template>

<script setup lang="ts">
const proTableRef = ref<MaProTableExpose>()
const options = ref({ requestOptions: { api: page } })
const schema = ref({
  searchItems: getSearchItems(),
  tableColumns: getTableColumns(),
})
</script>
```

**列配置**（`getTableColumns.tsx`）：
```tsx
export default function getTableColumns(): MaProTableColumns[] {
  return [
    { type: 'selection' },
    { type: 'index' },
    { label: () => '用户名', prop: 'username', minWidth: 120 },
    {
      label: () => '状态',
      prop: 'status',
      cellRender: ({ row }) => <ElTag type={row.status === 1 ? 'success' : 'danger'}>
        {row.status === 1 ? '启用' : '禁用'}
      </ElTag>
    },
    {
      type: 'operation',
      operationConfigure: {
        actions: [{ name: 'edit', onClick: ({ row }) => {} }]
      }
    }
  ]
}
```

**搜索配置**（`getSearchItems.tsx`）：
```tsx
export default function getSearchItems(): MaSearchItem[] {
  return [
    { label: () => '用户名', prop: 'username', render: 'input' },
    { label: () => '状态', prop: 'status', render: () => MaDictSelect, renderProps: { dictName: 'system-status' } },
  ]
}
```

**常用操作**：
```typescript
proTableRef.value.refresh()                    // 刷新
proTableRef.value.setRequestParams({...}, true) // 设置参数并刷新
proTableRef.value.getSelections()              // 获取选中行
```

### 6.2 其他表格组件

```vue
<!-- 基础表格 -->
<ma-table ref="table" />
<script setup>
useTable('table').then((table) => {
  table.setColumns([...])
  table.setData([...])
})
</script>

<!-- 选择表格 -->
<ma-select-table v-model="selected" :api="page" row-key="id" show-key="name" />
```

## 七、插件前端开发

插件前端代码位于 `plugin/{org}/{plugin}/web/`，安装时自动复制到 `web/src/plugins/{org}/{plugin}/`。

### 7.1 目录结构

```
plugin/{org}/{plugin}/web/
├── api/              # API接口定义
├── views/            # Vue页面组件
│   └── */index.vue   # 列表页
│   └── */form.vue    # 表单页
│   └── */data/       # 配置数据
├── locales/          # 多语言文件
├── dictionary/       # 字典数据（可选）
└── index.ts          # 插件入口（可选）
```

### 7.2 API接口定义

```typescript
// plugin/ds/article/web/api/article.ts
export interface ArticleVo { id: number; title: string; }

export function page(params: any) {
  return useHttp().get('/admin/article/article/list', { params })
}
```

**使用**：`import { page } from '$/ds/article/api/article.ts'`

### 7.3 路径别名

- `$/`：插件根目录（`$/ds/article/api/article.ts`）
- `@/`：前端项目根目录
- `~/`：前端 src 目录

### 7.4 安装与卸载

```bash
php bin/hyperf.php plugin:install ds/article    # 安装
php bin/hyperf.php plugin:uninstall ds/article # 卸载
```

**注意**：修改后需重新安装，开发时可直接在 `web/src/plugins/` 修改

## 八、常见问题

**Q1: 视频上传失败？**  
检查文件大小、格式、网络连接和后端接口。

**Q2: 分片上传进度不准确？**  
进度包括MD5计算（5%）、分片上传（10%-90%）、合并（90%-100%），确保 `onProgress` 正确更新UI。

**Q3: 字典数据找不到？**  
检查文件目录、文件名是否与字典名称一致。

**Q4: 表格数据不刷新？**  
调用 `proTableRef.value.refresh()` 或 `setRequestParams({...}, true)`。

**Q5: 表单在小屏幕显示异常？**  
使用 `useFormResponsive`，设置 `xsLabelPosition: 'top'`。

**Q6: 如何判断移动端？**  
使用 `useSettingStore().getMobileState()`（< 1024px 返回 true）。

**Q7: 插件前端代码修改后不生效？**  
重新安装插件，或开发时直接在 `web/src/plugins/` 修改。

**Q8: 如何引用插件API？**  
使用路径别名：`import { page } from '$/ds/article/api/article.ts'`
