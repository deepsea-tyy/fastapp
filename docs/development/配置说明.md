# 配置说明

## 1. 基础配置

### 应用配置 (config/config.php)

```php
$isDebug = env('APP_DEBUG', false);
return [
    'app_name' => env('APP_NAME', 'fastapp'),
    'scan_cacheable' => !$isDebug,
    'debug' => $isDebug,
    'env' => env('APP_ENV', 'prod'),
    StdoutLoggerInterface::class => [
        'log_level' => $isDebug ? [
            LogLevel::INFO, LogLevel::NOTICE, LogLevel::WARNING,
            LogLevel::ERROR, LogLevel::CRITICAL, LogLevel::ALERT, LogLevel::EMERGENCY,
        ] : [
            LogLevel::ERROR, LogLevel::CRITICAL, LogLevel::ALERT, LogLevel::EMERGENCY,
        ],
    ],
];
```

### 容器配置 (config/container.php)

```php
$configFromProviders = Plugin::loadProviderConfig();
$serverDependencies = $configFromProviders['dependencies'] ?? [];
$dependenciesPath = BASE_PATH . '/config/autoload/dependencies.php';
if (file_exists($dependenciesPath)) {
    $definitions = include $dependenciesPath;
    $serverDependencies = array_replace($serverDependencies, $definitions ?? []);
}
return ApplicationContext::setContainer(new Container(new DefinitionSource($serverDependencies)));
```

## 2. 数据库配置

### 数据库连接 (config/autoload/databases.php)

```php
return [
    'default' => [
        'driver' => env('DB_DRIVER', 'mysql'),
        'host' => env('DB_HOST', 'localhost'),
        'port' => env('DB_PORT', 3306),
        'database' => env('DB_DATABASE', 'hyperf'),
        'username' => env('DB_USERNAME', 'root'),
        'password' => env('DB_PASSWORD'),
        'charset' => env('DB_CHARSET', 'utf8mb4'),
        'collation' => env('DB_COLLATION', 'utf8mb4_unicode_ci'),
        'prefix' => env('DB_PREFIX', ''),
        'pool' => [
            'min_connections' => 1,
            'max_connections' => 20,
            'connect_timeout' => 10.0,
            'wait_timeout' => 3.0,
            'heartbeat' => -1,
            'max_idle_time' => (float)env('DB_MAX_IDLE_TIME', 60),
        ],
        'cache' => [
            'handler' => RedisHandler::class,
            'cache_key' => 'fastapp:%s:m:%s:%s:%s',
            'prefix' => 'model-cache',
            'ttl' => 86400 * 7,
            'empty_model_ttl' => 60,
            'load_script' => true,
            'use_default_value' => false,
        ],
        'commands' => [
            'gen:model' => [
                'path' => 'app/Model',
                'force_casts' => true,
                'with_comments' => true,
                'refresh_fillable' => true,
            ],
        ],
    ],
];
```

## 3. Redis配置

### Redis连接 (config/autoload/redis.php)

```php
return [
    'default' => [
        'host' => env('REDIS_HOST', 'localhost'),
        'auth' => env('REDIS_AUTH', null),
        'port' => (int)env('REDIS_PORT', 6379),
        'db' => (int)env('REDIS_DB', 0),
        'pool' => [
            'min_connections' => 1,
            'max_connections' => 10,
            'connect_timeout' => 10.0,
            'wait_timeout' => 3.0,
            'heartbeat' => -1,
            'max_idle_time' => (float)env('REDIS_MAX_IDLE_TIME', 60),
        ],
    ],
];
```

## 4. JWT配置

### JWT认证 (config/autoload/jwt.php)

```php
return [
    'default' => [
        'driver' => Jwt::class,
        'key' => InMemory::base64Encoded(env('JWT_SECRET')),
        'alg' => new Sha256(),
        'ttl' => (int) env('JWT_TTL', 3600),
        'refresh_ttl' => (int) env('JWT_REFRESH_TTL', 7200),
        'blacklist' => [
            'enable' => true,
            'prefix' => 'jwt_blacklist',
            'connection' => 'default',
            'ttl' => (int) env('JWT_BLACKLIST_TTL', 7201),
        ],
        'claims' => [
            RegisteredClaims::ISSUER => (string) env('APP_NAME'),
        ],
    ],
    'api' => [
        // 同上，使用 JWT_API_SECRET
        'key' => InMemory::base64Encoded(env('JWT_API_SECRET')),
    ],
];
```

## 5. 中间件配置

### 全局中间件 (config/autoload/middlewares.php)

```php
return [
    'http' => [
        TranslationMiddleware::class,      // 多语言识别
        ValidationMiddleware::class,      // 验证器处理
        CorsMiddleware::class,             // 跨域（正式环境建议关闭）
    ],
];
```

## 6. Swagger配置

### API文档 (config/autoload/swagger.php)

```php
return [
    'enable' => env('APP_DEBUG', false),  // 仅调试模式启用
    'port' => (int)env('APP_DOC_PORT'),
    'json_dir' => BASE_PATH . '/storage/swagger',
    'html' => file_get_contents(BASE_PATH . '/storage/swagger/index.html'),
    'url' => '/swagger',
    'auto_generate' => true,
    'scan' => [
        'paths' => [
            BASE_PATH . '/app/Common',
            BASE_PATH . '/app/Schema',
            BASE_PATH . '/app/Http/Api',
        ],
    ],
    'processors' => [],
];
```

## 7. WebSocket配置

### WebSocket服务器 (config/autoload/server.php)

```php
return [
    'mode' => \SWOOLE_PROCESS,
    'servers' => [
        [
            'name' => 'http',
            'type' => Server::SERVER_HTTP,
            'host' => '0.0.0.0',
            'port' => (int)env('APP_PORT'),
            'sock_type' => \SWOOLE_SOCK_TCP,
            'callbacks' => [
                Event::ON_REQUEST => [Hyperf\HttpServer\Server::class, 'onRequest'],
            ],
        ],
        [
            'name' => 'ws',
            'type' => Server::SERVER_WEBSOCKET,
            'host' => '0.0.0.0',
            'port' => (int)env('WS_PORT', 9502),
            'sock_type' => \SWOOLE_SOCK_TCP,
            'callbacks' => [
                Event::ON_HAND_SHAKE => [Hyperf\WebSocketServer\Server::class, 'onHandShake'],
                Event::ON_MESSAGE => [Hyperf\WebSocketServer\Server::class, 'onMessage'],
                Event::ON_CLOSE => [Hyperf\WebSocketServer\Server::class, 'onClose'],
            ],
            'settings' => [
                Constant::OPTION_HEARTBEAT_IDLE_TIME => 60,
                Constant::OPTION_HEARTBEAT_CHECK_INTERVAL => 30,
            ],
        ],
    ],
    'settings' => [
        Constant::OPTION_ENABLE_STATIC_HANDLER => true,
        Constant::OPTION_ENABLE_COROUTINE => true,
        Constant::OPTION_WORKER_NUM => env('APP_DEBUG') ? 1 : swoole_cpu_num(),
        Constant::OPTION_PID_FILE => BASE_PATH . '/runtime/hyperf.pid',
        Constant::OPTION_OPEN_TCP_NODELAY => true,
        Constant::OPTION_MAX_COROUTINE => 100000,
        Constant::OPTION_OPEN_HTTP2_PROTOCOL => true,
        Constant::OPTION_MAX_REQUEST => 100000,
        Constant::OPTION_UPLOAD_MAX_FILESIZE => 10 * 1024 * 1024,
        Constant::OPTION_HTTP_INDEX_FILES => ['index.html'],
        Constant::OPTION_SOCKET_BUFFER_SIZE => 3 * 1024 * 1024,
        Constant::OPTION_PACKAGE_MAX_LENGTH => 16 * 1024 * 1024,
        Constant::OPTION_TASK_WORKER_NUM => env('APP_DEBUG') ? 1 : swoole_cpu_num(),
        Constant::OPTION_TASK_ENABLE_COROUTINE => false,
    ],
    'callbacks' => [
        Event::ON_WORKER_START => [WorkerStartCallback::class, 'onWorkerStart'],
        Event::ON_PIPE_MESSAGE => [PipeMessageCallback::class, 'onPipeMessage'],
        Event::ON_WORKER_EXIT => [WorkerExitCallback::class, 'onWorkerExit'],
        Event::ON_TASK => [Hyperf\Framework\Bootstrap\TaskCallback::class, 'onTask'],
        Event::ON_FINISH => [Hyperf\Framework\Bootstrap\FinishCallback::class, 'onFinish'],
    ],
];
```

### WebSocket路由 (config/routes.php)

```php
Router::addServer('ws', function () {
    Router::get('/ws', \App\Websocket\WsController::class);
});
```

**环境变量**：`.env` 中配置 `WS_PORT=9502`

详细文档请参考 [WebSocket开发文档](../features/WebSocket开发文档.md)

## 8. 日志配置

### 日志系统 (config/autoload/logger.php)

```php
return [
    'default' => [
        'handler' => [
            'class' => RotatingFileHandler::class,
            'constructor' => [
                'filename' => BASE_PATH . '/runtime/logs/app.log',
                'level' => $isDebug ? Level::Debug : Level::Info,
                'maxFiles' => $isDebug ? 1 : 10,  // 调试模式仅保留1个文件
                'dateFormat' => 'Y-m-d',
            ],
        ],
        'formatter' => [
            'class' => LineFormatter::class,
            'constructor' => [
                'format' => null,
                'dateFormat' => 'Y-m-d H:i:s',
                'allowInlineLineBreaks' => true,
            ],
        ],
        'processor' => [
            'class' => UuidRequestIdProcessor::class,
        ],
    ],
    'error' => [
        'handler' => [
            'class' => RotatingFileHandler::class,
            'constructor' => [
                'filename' => BASE_PATH . '/runtime/logs/error.log',
                'level' => Level::Error,
                'maxFiles' => $isDebug ? 1 : 10,
                'dateFormat' => 'Y-m-d',
            ],
        ],
        'formatter' => [
            'class' => LineFormatter::class,
            'constructor' => [
                'format' => null,
                'dateFormat' => 'Y-m-d H:i:s',
                'allowInlineLineBreaks' => true,
            ],
        ],
        'processor' => [
            'class' => UuidRequestIdProcessor::class,
        ],
    ],
    'sql' => [
        'handler' => [
            'class' => RotatingFileHandler::class,
            'constructor' => [
                'filename' => BASE_PATH . '/runtime/logs/sql.log',
                'level' => $isDebug ? Level::Info : Level::Emergency,
                'maxFiles' => $isDebug ? 1 : 10,
                'dateFormat' => 'Y-m-d',
            ],
        ],
        'formatter' => [
            'class' => LineFormatter::class,
            'constructor' => [
                'format' => null,
                'dateFormat' => 'Y-m-d H:i:s',
                'allowInlineLineBreaks' => true,
            ],
        ],
        'processor' => [
            'class' => UuidRequestIdProcessor::class,
        ],
    ],
    'queue' => [
        'handler' => [
            'class' => RotatingFileHandler::class,
            'constructor' => [
                'filename' => BASE_PATH . '/runtime/logs/queue.log',
                'level' => $isDebug ? Level::Debug : Level::Info,
                'maxFiles' => $isDebug ? 1 : 10,
                'dateFormat' => 'Y-m-d',
            ],
        ],
        'formatter' => [
            'class' => LineFormatter::class,
            'constructor' => [
                'format' => null,
                'dateFormat' => 'Y-m-d H:i:s',
                'allowInlineLineBreaks' => true,
            ],
        ],
        'processor' => [
            'class' => UuidRequestIdProcessor::class,
        ],
    ],
    'websocket' => [
        'handler' => [
            'class' => RotatingFileHandler::class,
            'constructor' => [
                'filename' => BASE_PATH . '/runtime/logs/websocket.log',
                'level' => $isDebug ? Level::Debug : Level::Info,
                'maxFiles' => $isDebug ? 1 : 10,
                'dateFormat' => 'Y-m-d',
            ],
        ],
        'formatter' => [
            'class' => LineFormatter::class,
            'constructor' => [
                'format' => null,
                'dateFormat' => 'Y-m-d H:i:s',
                'allowInlineLineBreaks' => true,
            ],
        ],
        'processor' => [
            'class' => UuidRequestIdProcessor::class,
        ],
    ],
];
```

## 9. 缓存配置

### 缓存系统 (config/autoload/cache.php)

```php
return [
    'default' => [
        'driver' => Hyperf\Cache\Driver\RedisDriver::class,
        'packer' => Hyperf\Codec\Packer\PhpSerializerPacker::class,
        'prefix' => 'fastapp:',
    ],
];
```

## 10. 事件监听器配置

### 自动注册机制

项目中的监听器使用 `#[Listener]` 注解自动注册，**无需手动配置**。

**监听器位置**：`app/Common/Subscriber/`

**已注册的监听器**：
- `DbQueryExecutedSubscriber` - SQL 执行日志记录
- `BootApplicationSubscriber` - 应用启动和迁移文件管理
- `FailToHandleSubscriber` - 命令执行失败日志
- `QueueHandleSubscriber` - 异步队列处理日志
- `ResumeExitCoordinatorSubscriber` - Worker 退出协调器
- `UserSubscriber` - 用户登录事件处理

### 手动配置（可选）

如需手动配置，在 `config/autoload/listeners.php` 中配置：

```php
return [
    // 仅用于需要手动注册的监听器
    ErrorExceptionHandler::class,
];
```

## 11. 依赖注入配置

### 依赖注入 (config/autoload/dependencies.php)

```php
return [
    // 接口绑定实现
    UserServiceInterface::class => UserService::class,
    // 单例绑定
    CacheInterface::class => Redis::class,
];
```

## 12. 环境变量配置

### 开发环境 (.env.development)

```env
APP_ENV=development
APP_DEBUG=true
APP_NAME="FastApp Development"

DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=fastapp_dev
DB_USERNAME=root
DB_PASSWORD=

REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=

JWT_SECRET=development-secret-key
WS_PORT=9502
```

### 生产环境 (.env.production)

```env
APP_ENV=production
APP_DEBUG=false
APP_NAME="FastApp Production"

DB_HOST=db.production.com
DB_PORT=3306
DB_DATABASE=fastapp_prod
DB_USERNAME=prod_user
DB_PASSWORD=strong_password

REDIS_HOST=redis.production.com
REDIS_PORT=6379
REDIS_PASSWORD=redis_password

JWT_SECRET=production-secret-key-base64-encoded
WS_PORT=9502
```

## 13. 路由配置

### 注解路由

框架使用 Swagger 注解配置路由，无需在 `routes.php` 中手动配置：

```php
use Hyperf\Swagger\Annotation\Get;
use Hyperf\Swagger\Annotation\Post;

class UserController extends AbstractController
{
    #[Post(path: '/api/user/register', summary: '用户注册', tags: ['用户接口'])]
    public function register() {}
    
    #[Get(path: '/api/user/profile', summary: '用户信息', tags: ['用户接口'])]
    public function profile() {}
}
```

## 14. 配置最佳实践

### 环境特定配置

```php
// 根据环境加载不同配置
$config = env('APP_ENV') === 'production' 
    ? require 'config/production/database.php'
    : require 'config/development/database.php';
```

### 配置缓存

```bash
# 生成配置缓存（生产环境）
php bin/hyperf.php config:cache

# 清除配置缓存
php bin/hyperf.php config:clear
```

### 配置验证

```php
// 在服务启动时验证关键配置
if (empty(env('JWT_SECRET'))) {
    throw new \RuntimeException('JWT_SECRET environment variable is required');
}
```
