# 开发规范指南

## 1. 代码分层架构

```
Controller → Service → Repository → Model
    ↓           ↓          ↓         ↓
   HTTP      业务逻辑    数据操作   数据模型
```

## 2. 控制器开发规范

### 控制器职责

| 职责 | 说明 |
|------|------|
| **数据验证** | 使用 FormRequest 进行请求数据验证 |
| **数据准备** | 对请求数据进行预处理和格式化 |
| **用户信息传入** | 从 CurrentUser 获取用户ID（`created_by`、`updated_by`） |
| **调用服务层** | 调用 Service 层处理业务逻辑 |
| **返回响应** | 使用统一的响应格式返回结果 |

⚠️ **重要**：控制器层只负责数据验证、准备和传递，不包含业务逻辑。

### Admin 和 Api 控制器区别

| 控制器类型 | 路由前缀 | 业务场景 | 认证方式 | 中间件配置 |
|-----------|----------|----------|----------|------------|
| **Api控制器** | `/api/模块/功能` | 面向移动端/前端API | JWT Token认证 | 方法级别配置 |
| **Admin控制器** | `/admin/模块/功能` | 后台管理系统 | AccessToken + Permission + Operation | 类级别统一配置 |

### 控制器示例

#### Admin 控制器示例

```php
use App\Http\Admin\Controller\AbstractController;
use App\Common\Middleware\AccessTokenMiddleware;
use App\Common\Middleware\OperationMiddleware;
use App\Http\Admin\Middleware\PermissionMiddleware;
use App\Http\CurrentUser;
use Hyperf\HttpServer\Annotation\Middleware;
use Hyperf\Swagger\Annotation as OA;

#[OA\HyperfServer('http')]
#[Middleware(middleware: AccessTokenMiddleware::class, priority: 100)]
#[Middleware(middleware: PermissionMiddleware::class, priority: 99)]
#[Middleware(middleware: OperationMiddleware::class, priority: 98)]
class ArticleController extends AbstractController
{
    public function __construct(
        protected readonly ArticleService $service,
        protected readonly CurrentUser $currentUser
    ) {}

    #[OA\Get(path: '/admin/article/article/list', summary: '文章列表', tags: ['文章'])]
    #[Permission(code: 'article:article:list')]
    public function pageList(): Result
    {
        return $this->success($this->service->page(
            $this->getRequestData(),
            $this->getCurrentPage(),
            $this->getPageSize()
        ));
    }

    #[OA\Post(path: '/admin/article/article/create', summary: '文章新增', tags: ['文章'])]
    #[Permission(code: 'article:article:create')]
    public function create(ArticleRequest $request): Result
    {
        $this->service->create(array_merge($request->validated(), [
            'created_by' => $this->currentUser->id(),
        ]));
        return $this->success();
    }

    #[OA\Put(path: '/admin/article/article/save/{id}', summary: '文章保存', tags: ['文章'])]
    #[Permission(code: 'article:article:save')]
    public function save(int $id, ArticleRequest $request): Result
    {
        $this->service->updateById($id, array_merge($request->validated(), [
            'updated_by' => $this->currentUser->id(),
        ]));
        return $this->success();
    }

    #[OA\Delete(path: '/admin/article/article/delete', summary: '文章删除', tags: ['文章'])]
    #[RequestBody(content: new JsonContent(type: 'array', items: new OA\Items(type: 'integer'), example: '[1, 2, 3]'))]
    #[Permission(code: 'article:article:delete')]
    public function delete(): Result
    {
        $this->service->deleteById($this->getRequestData(), []);
        return $this->success();
    }
}
```

#### Api 控制器示例

```php
use App\Common\AbstractController;
use App\Common\Middleware\TokenMiddleware;
use App\Common\Result;
use App\Http\CurrentUser;
use App\Http\PassportService;
use Hyperf\HttpServer\Annotation\Middleware;
use Hyperf\Swagger\Annotation as OA;

class UserController extends AbstractController
{
    public function __construct(
        private readonly PassportService $passportService,
        private readonly CurrentUser $currentUser,
    ) {}

    #[OA\Post(path: '/api/user/register', summary: '用户注册', tags: ['用户接口'])]
    public function register(UserRequest $request): Result
    {
        $this->passportService->register($request->validated());
        return $this->success([], '注册成功');
    }

    #[OA\Get(path: '/api/user/info', summary: '获取用户信息', tags: ['用户接口'])]
    #[Middleware(TokenMiddleware::class)]
    public function info(): Result
    {
        return $this->success($this->currentUser->user());
    }
}
```

## 3. 服务层规范

### 服务层职责

| 职责 | 说明 |
|------|------|
| **业务逻辑处理** | 实现具体的业务逻辑 |
| **数据流转** | 调用 Repository 层进行数据操作 |
| **业务规则验证** | 进行业务层面的验证（非数据格式验证） |

⚠️ **重要**：
- 服务层**不做数据验证**，数据验证由控制器层的 FormRequest 完成
- 服务层接收的数据应该是已经验证过的、格式正确的数据

### 服务层示例

```php
// app/Common/IService.php（抽象类）
abstract class IService
{
    public function getList(array $params): Collection;
    public function create(array $data): mixed;
    public function updateById(mixed $id, array $data): mixed;
    public function deleteById(mixed $id, array $where = []): int;
    public function page(array $params, int $page = 1, int $pageSize = 10): array;
}

// 实际服务类
class UserService extends IService
{
    public function __construct(protected UserRepository $repository) {}
    
    public function getList(array $params): Collection
    {
        return $this->repository->list($params);
    }
}
```

## 4. 数据仓库规范

```php
class UserRepository extends IRepository
{
    public function __construct(protected readonly User $model) {}
    
    // 可选：重写handleSearch方法实现自定义搜索逻辑
    public function handleSearch(Builder $query, array $params): Builder
    {
        return $query
            ->when(isset($params['username']), function ($q) use ($params) {
                $q->where('username', 'like', '%' . $params['username'] . '%');
            });
    }
}
```

### deleteById 方法说明

`IRepository::deleteById()` 方法支持 `$where` 参数，用于额外的条件过滤：

```php
public function deleteById(mixed $id, array $where = []): int
```

**参数说明**：
- `$id`: 要删除的ID（支持单个ID或ID数组），通常使用 `$this->getRequestData()` 获取请求体数组
- `$where`: 额外的where条件数组（可选），用于数据权限过滤等场景

**使用场景**：
- 数据权限过滤：`deleteById($this->getRequestData(), ['created_by' => $userId])`
- 状态过滤：`deleteById($this->getRequestData(), ['status' => 1])`
- 多条件过滤：`deleteById($this->getRequestData(), ['type' => 1, 'status' => 1])`

**请求格式**：
- ✅ 正确：请求体直接是数组 `[1, 2, 3]`
- ❌ 错误：对象格式 `{"ids": [1, 2, 3]}`

⚠️ **注意**：如果提供了 `$where` 参数，会先应用where条件再删除，可用于数据权限控制。

## 5. 请求验证规范

### ActionRulesTrait 方式（推荐）

```php
use App\Common\Request\Traits\ActionRulesTrait;

class UserRequest extends FormRequest
{
    use ActionRulesTrait;

    // 通用规则（所有方法都会应用）
    public function commonRules(): array
    {
        return [
            'username' => 'string|max:16',
            'password' => 'string|max:32',
        ];
    }

    // 自动匹配 create 方法
    public function createRules(): array
    {
        return [
            'username' => 'required|string|max:16',
            'password' => 'required|string|max:32',
        ];
    }

    // 自动匹配 save/update 方法
    public function saveRules(): array
    {
        return [
            'username' => 'sometimes|string|max:16',
        ];
    }
}
```

### scene 方式（复杂场景）

```php
class UserRequest extends FormRequest
{
    protected array $scenes = [
        'register' => ['username' => 'required', 'password' => 'required|confirmed'],
        'login' => ['username' => 'required', 'password' => 'required'],
    ];

    public function rules(): array
    {
        return ['username' => 'string|max:16', 'password' => 'string|max:32'];
    }
}

// 控制器中使用
$request->scene('register')->validated();
```

## 6. 数据模型规范

### Model 基本结构

```php
use Hyperf\DbConnection\Model\Model;

/**
 * 用户模型
 * @property int $id ID
 * @property string $username 用户名
 * @property \Carbon\Carbon $created_at 创建时间
 */
class User extends Model
{
    protected ?string $table = 'user';
    protected array $fillable = ['username', 'email'];
    protected array $casts = ['id' => 'integer', 'created_at' => 'datetime'];
    protected array $hidden = ['password'];
}
```

### Model 类型声明说明

⚠️ **重要**：代码生成器生成的Model只有PHPDoc注释（`@property`），没有类属性类型声明。

| 类型 | 说明 | 示例 |
|------|------|------|
| **PHPDoc注释** | 代码生成器自动生成 | `@property int $id ID` |
| **类属性类型声明** | 需手动添加（PHP 8.0+） | `public int $id;` |

**建议**：
- 代码生成器生成的Model已包含PHPDoc注释，IDE可以正常提示
- 如需更强的类型检查，可手动添加类属性类型声明

## 7. 命名规范

| 类型 | 命名规则 | 示例 |
|------|---------|------|
| **文件命名** | 大驼峰命名法 | `UserController.php`, `UserService.php` |
| **方法命名** | 小驼峰命名法 | `getList()`, `create()`, `delete()` |
| **变量命名** | 小驼峰命名法 | `$userId`, `$userName` |

## 8. 代码风格

### 注释规范

```php
/**
 * 用户服务类
 */
class UserService
{
    /**
     * 获取用户列表
     */
    public function getList(array $params): array
    {
        // 业务逻辑
    }
}
```

### 异常处理

```php
try {
    $result = $this->service->process($data);
} catch (BusinessException $e) {
    return $this->error($e->getMessage());
} catch (\Exception $e) {
    Log::error('处理失败', ['error' => $e->getMessage()]);
    return $this->error('系统错误');
}
```

## 9. 测试规范

### 单元测试

```php
class UserServiceTest extends TestCase
{
    public function testGetList()
    {
        $service = new UserService();
        $result = $service->getList([]);
        $this->assertIsArray($result);
    }
}
```

### 集成测试

```php
class UserControllerTest extends HttpTestCase
{
    public function testRegister()
    {
        $response = $this->post('/api/user/register', [
            'username' => 'test',
            'password' => '123456'
        ]);
        $response->assertStatus(200);
    }
}
```
