# FastApp 插件系统使用指南

## 概述

FastApp 插件系统提供完整的模块化扩展机制，支持创建、安装、管理和卸载功能插件。插件可包含后端 PHP 代码、前端 Vue 组件、数据库迁移等完整功能模块。

## 插件目录结构

```
plugin/
├── ds/                          # 组织名称目录
│   ├── article/                 # 插件名称目录
│   │   ├── config.json         # 插件配置文件
│   │   ├── install.lock        # 安装锁定文件
│   │   ├── README.md           # 插件说明文档
│   │   ├── src/                # 后端PHP源代码
│   │   │   ├── ConfigProvider.php
│   │   │   ├── InstallScript.php
│   │   │   ├── UninstallScript.php
│   │   │   ├── Http/           # HTTP控制器
│   │   │   ├── Model/          # 数据模型
│   │   │   ├── Repository/     # 数据仓库
│   │   │   └── Service/        # 业务服务
│   │   ├── Database/           # 数据库相关
│   │   │   ├── Migrations/     # 数据库迁移
│   │   │   └── Seeders/        # 数据填充
│   │   └── web/                # 前端代码
│   │       ├── api/            # API接口定义
│   │       ├── views/          # Vue页面组件
│   │       ├── locales/        # 多语言文件
│   │       └── assets/         # 静态资源
│   └── system-config/          # 另一个插件
```

## 插件配置文件 (config.json)

```json
{
  "name": "ds/article",
  "version": "1.0.6",
  "type": "mixed",
  "description": "文章管理插件",
  "author": [{"name": "ds"}],
  "composer": {
    "require": {},
    "psr-4": {
      "Plugin\\Ds\\Article\\": "src"
    },
    "installScript": "Plugin\\Ds\\Article\\InstallScript",
    "uninstallScript": "Plugin\\Ds\\Article\\UninstallScript",
    "config": "Plugin\\Ds\\Article\\ConfigProvider"
  },
  "package": {
    "dependencies": []
  }
}
```

## 插件类型

| 类型 | 命令行参数 | 配置文件值 | 说明 |
|------|-----------|-----------|------|
| **mix** | `mix` | `"mixed"` | 混合类型（包含前后端） |
| **frond** | `frond` | `"frond"` | 前端类型（仅前端代码） |
| **backend** | `backend` | `"backend"` | 后端类型（仅后端代码） |

⚠️ **重要**：
- **命令行参数**：创建插件时，`--type` 参数必须使用枚举键名（`mix`、`frond`、`backend`），不是全称（`mixed`、`frontend`、`backend`）
- **配置文件值**：`config.json` 中的 `type` 字段存储的是枚举值，`mix` 类型对应 `"mixed"`

如果命令报错 `Plugin type is empty`，请检查 `--type` 参数值是否正确。

## 插件命令使用

### 1. 查看插件列表

```bash
php bin/hyperf.php plugin:local-list
```

### 2. 创建新插件

```bash
# 创建插件基础结构
php bin/hyperf.php plugin:create <组织>/<插件名> --name="插件显示名称" --type=mix --description="插件描述" --author="作者名"

# 示例：创建文章管理插件
php bin/hyperf.php plugin:create ds/article --name="文章管理" --type=mix --description="文章发布和管理功能" --author="ds"
```

⚠️ **重要**：`--type` 参数必须使用枚举键名（`mix`、`frond`、`backend`），不要使用全称。

### 3. 安装插件

```bash
# 安装本地插件
php bin/hyperf.php plugin:install ds/article

# 静默安装（无需确认）
php bin/hyperf.php plugin:install ds/article --yes
```

### 4. 卸载插件

```bash
# 卸载插件
php bin/hyperf.php plugin:uninstall ds/article

# 静默卸载
php bin/hyperf.php plugin:uninstall ds/article --yes
```

### 5. 插件脚本管理

```bash
# 显示插件可发布的配置文件
php bin/hyperf.php plugin:script ds/article --show

# 发布插件配置文件
php bin/hyperf.php plugin:script ds/article --id=<配置ID>

# 强制覆盖发布
php bin/hyperf.php plugin:script ds/article --id=<配置ID> --force
```

## 插件开发指南

### 1. 插件命名规范

- **组织名**：使用小写字母，如 `ds`
- **插件名**：使用小写字母和连字符，如 `article-manager`
- **命名空间**：`Plugin\\组织名\\插件名\\`

### 2. 核心文件说明

#### ConfigProvider.php

```php
<?php
namespace Plugin\Ds\Article;

class ConfigProvider
{
    public function __invoke()
    {
        return [
            'annotations' => [
                'scan' => [
                    'paths' => [__DIR__],
                ],
            ],
        ];
    }
}
```

#### InstallScript.php

```php
<?php
namespace Plugin\Ds\Article;

class InstallScript {
    public function __invoke(){
        // 安装时执行的脚本
    }
}
```

#### UninstallScript.php

```php
<?php
namespace Plugin\Ds\Article;

class UninstallScript {
    public function __invoke(){
        // 卸载时执行的脚本
    }
}
```

### 3. 数据库迁移和种子文件

在 `Database/Migrations/` 目录下创建迁移文件：

```php
<?php
declare(strict_types=1);

use Hyperf\Database\Migrations\Migration;
use Hyperf\Database\Schema\Blueprint;
use Hyperf\Database\Schema\Schema;

class CreateArticleTable extends Migration
{
    public function up(): void
    {
        Schema::create('article', function (Blueprint $table) {
            $table->bigIncrements('id');
            $table->string('title')->comment('标题');
            $table->text('content')->comment('内容');
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('article');
    }
}
```

在 `Database/Seeders/` 目录下创建种子文件（可选）：

```php
<?php
declare(strict_types=1);

use Hyperf\Database\Seeder\Seeder;

class ArticleSeeder extends Seeder
{
    public function run(): void
    {
        // 数据填充逻辑
    }
}
```

> 💡 **提示**：插件安装时会自动执行迁移和种子文件，卸载时会自动回滚迁移。

### 4. 前端开发

在 `web/` 目录下开发前端组件：
- `web/api/` - TypeScript API 接口定义
- `web/views/` - Vue 页面组件
- `web/locales/` - 多语言文件
- `web/assets/` - 静态资源

## 插件生命周期

1. **创建阶段**：使用 `plugin:create` 命令创建插件基础结构
2. **开发阶段**：编写插件功能代码
3. **安装阶段**：执行安装脚本，注册自动加载，运行迁移
4. **运行阶段**：插件功能正常使用
5. **卸载阶段**：执行卸载脚本，清理数据

## 最佳实践

### 1. 插件依赖管理

在 `config.json` 中声明依赖：

```json
{
  "composer": {
    "require": {
      "monolog/monolog": "^2.0"
    }
  },
  "package": {
    "dependencies": ["@vue/composition-api"]
  }
}
```

### 2. 错误处理

```php
// 在安装脚本中处理错误
try {
    // 安装逻辑
} catch (\Exception $e) {
    throw new \RuntimeException('插件安装失败: ' . $e->getMessage());
}
```

### 3. 数据备份

在卸载脚本中提供数据备份选项：

```php
public function __invoke(){
    if ($this->confirm('是否备份插件数据？')) {
        // 执行备份逻辑
    }
    // 卸载逻辑
}
```

## 常见问题

**Q: 插件安装失败怎么办？**  
A: 检查插件配置文件格式是否正确，依赖是否满足，权限是否足够。

**Q: 插件卸载后数据会保留吗？**  
A: 默认不会保留，建议在卸载前进行数据备份。

**Q: 如何更新插件？**  
A: 先卸载旧版本，再安装新版本，注意数据迁移。

**Q: 插件冲突如何处理？**  
A: 检查插件依赖关系，确保没有命名空间冲突。

## 总结

FastApp 插件系统提供了完整的模块化开发解决方案，支持前后端分离开发、依赖管理、生命周期控制等功能。通过合理的插件设计，可以实现代码的高度复用和系统功能的灵活扩展。
