# 核心功能概览

本文档是 FastApp 框架核心功能的概览，每个功能都有简要介绍和详细文档链接。

## 1. 统一响应格式系统

### Result 类

```php
class Result implements Arrayable
{
    public function __construct(
        public ResultCode $code = ResultCode::SUCCESS,
        public ?string $message = null,
        public mixed $data = []
    ) {}
}
```

### ResultCode 枚举

```php
enum ResultCode: int
{
    case SUCCESS = 200;
    case FAIL = 500;
    case UNAUTHORIZED = 401;
    case FORBIDDEN = 403;
    case NOT_FOUND = 404;
    case METHOD_NOT_ALLOWED = 405;
    case NOT_ACCEPTABLE = 406;
    case UNPROCESSABLE_ENTITY = 422;
    case DISABLED = 423;
}
```

### 控制器基类使用

```php
class UserController extends AbstractController
{
    public function index()
    {
        return $this->success($data, '获取成功');
    }
    
    public function store()
    {
        return $this->error('创建失败');
    }
}
```

## 2. JWT 认证系统

### 配置结构

```php
// config/autoload/jwt.php
return [
    'default' => [
        'driver' => Jwt::class,
        'key' => InMemory::base64Encoded(env('JWT_SECRET')),
        'alg' => new Sha256(),
        'ttl' => 3600,
        'refresh_ttl' => 7200,
        'blacklist' => [
            'enable' => true,
            'prefix' => 'jwt_blacklist',
        ],
    ],
];
```

### 中间件使用

- `AccessTokenMiddleware` - Access Token 验证
- `RefreshTokenMiddleware` - Refresh Token 验证

## 3. 代码生成器

代码生成器根据数据库表结构自动生成完整的 CRUD 代码。

### 快速开始

```bash
# 生成CRUD代码（包含前后端）
php bin/hyperf.php ds:crud --table=users --module=admin

# 生成纯API代码（只生成后端）
php bin/hyperf.php ds:crud --table=users --module=api --target=api
```

### 生成内容

- **后端代码**：Model、Controller、Service、Repository、Request
- **前端代码**：Vue组件、TypeScript接口、表单配置（Admin模式）
- **数据库**：菜单SQL文件
- **语言包**：多语言配置文件

详细文档请参考 [代码生成器文档](./代码生成器.md)

## 4. 权限管理系统

FastApp 采用基于 RBAC（基于角色的访问控制）的权限系统，包含功能权限和数据权限两大核心模块。

### 核心特性

- **功能权限**：控制用户可以访问哪些菜单和功能
- **数据权限**：控制用户可以访问哪些数据范围
- **权限注解**：使用 `@Permission` 注解轻松控制权限
- **数据范围工具**：使用 `DataScopeTool` 自动应用数据权限过滤

### 权限模型

- `User` - 用户模型
- `Role` - 角色模型
- `Menu` - 菜单模型
- `Permission` - 权限模型

详细文档请参考：
- [权限系统使用文档](./权限系统使用文档.md) - 主文档
- [用户部门与角色部门配合使用详解](./用户部门与角色部门配合使用详解.md) - 数据权限详细说明

## 5. 文件上传系统

### 上传配置

```php
$upload = UploadFactory::create($type);
$result = $upload->upload($file);
```

### 文档锁机制

文件上传系统内置了文档锁（文件去重）机制，通过文件的 MD5 哈希值来防止重复上传相同的文件。

**工作原理**：
1. 上传文件时，系统会计算文件的 MD5 哈希值
2. 在保存文件前，系统会检查数据库中是否已存在相同哈希值的文件
3. 如果文件已存在，直接返回已存在的附件记录，不会重复保存文件
4. 如果文件不存在，则正常上传并保存

**优势**：
- 节省存储空间：相同文件只保存一份
- 提高上传效率：重复文件无需重新上传
- 保证数据一致性：相同文件使用相同的附件记录

## 6. Excel 导入导出系统

### 抽象基类设计

框架提供了两个抽象基类用于 Excel 处理：

**AbsExport（导出基类）**
- 支持分片导出大数据量
- 自动样式设置和列宽调整
- 支持自定义预处理

**AbsImport（导入基类）**
- 支持分片读取大数据量
- 支持标题行配置
- 提供验证和处理抽象方法

### 导出使用示例

```php
// 基础导出
$export = new UserExport();
$filePath = $export->setSavePath(BASE_PATH . '/storage')
    ->setHeaders(['姓名', '邮箱', '手机号'])
    ->setData([...])
    ->generate();

// 分片导出（大数据量）
$export->setChunkSize(1000)->generateChunked();
```

### 导入使用示例

```php
$import = new UserImport();
$import->setHeaderRows(2)->setChunkSize(10);

if ($import->loadFile('users.xlsx')) {
    while ($import->hasMoreData()) {
        $data = $import->readData(true);
        foreach ($data as $index => $row) {
            if ($import->validateRow($row, $index)) {
                $import->processRow($row, $index);
            }
        }
    }
}
```

### 自定义实现

```php
class UserExport extends AbsExport
{
    protected function preprocessData(array $data): array
    {
        // 数据预处理逻辑
        return array_map(function($user) {
            return [$user['id'], $user['name'], date('Y-m-d', $user['created_at'])];
        }, $data);
    }
}

class UserImport extends AbsImport
{
    public function validateRow(array $rowData, int $rowIndex): bool
    {
        return !empty($rowData[0]) && !empty($rowData[1]);
    }

    public function processRow(array $rowData, int $rowIndex): bool
    {
        return User::create([
            'name' => $rowData[0],
            'email' => $rowData[1],
        ]) !== null;
    }
}
```

## 7. 事件系统

### 事件定义

```php
final class UserLoginEvent
{
    public function __construct(
        private readonly User $user,
        private readonly string $ip,
        private readonly string $os,
        private readonly string $device,
    ) {}
}
```

### 异步事件分发（推荐）

项目提供了封装的 `Tools::eventDispatcher()` 方法，**强烈推荐使用**：

```php
use App\Common\Tools;

// 异步分发事件，不阻塞主流程
Tools::eventDispatcher(new UserLoginEvent($user, $ip, $os, $device));
```

**优势**：
- ✅ 异步执行：在独立协程中执行，不阻塞主流程
- ✅ 异常隔离：监听器异常不会影响调用者
- ✅ 统一封装：统一的错误处理和日志记录

详细文档请参考 [Hyperf监听器与异步操作指南](./Hyperf监听器与异步操作指南.md)

## 8. Tools 工具类

FastApp 提供了 `Tools` 工具类，封装了常用的异步操作方法。

### 核心方法

#### 日志记录

```php
// 异步写入日志到指定channel
Tools::logAsync('API request failed', 'error', 'ip-location', 'error');
```

#### 事件分发

```php
// 异步分发事件
Tools::eventDispatcher(new YourEvent($data));
```

#### 队列任务分发

```php
// 异步分发Redis队列任务
Tools::redisDispatcher($job, $delay, $maxAttempts, $pool);
```

#### 语言和翻译

```php
// 获取当前语言代码
$lang = Tools::lang(); // 从请求头获取
$lang = Tools::lang($userId); // 从用户缓存获取
$lang = Tools::lang($userId, true); // 格式化：zh-CN

// 翻译函数
$text = Tools::__('user.name', ['name' => 'John'], $userId);

// 从多语言数据数组中获取对应文本
$text = Tools::formatLang([
    ['lang' => 'zh_CN', 'text' => '中文'],
    ['lang' => 'en', 'text' => 'English']
]);
```

#### 用户缓存

```php
// 设置用户缓存（Hash）
Tools::setUserCache($uid, ['name' => 'John', 'email' => 'john@example.com']);

// 获取用户缓存（Hash）
$data = Tools::getUserCache($uid, ['name', 'email']);
// 返回：['name' => 'John', 'email' => 'john@example.com']

// 获取单个字段
$name = Tools::getUserCache($uid, 'name');
// 返回：'John'
```

#### 编号生成

```php
// 生成订单编号：ORD20251108000001
$orderNo = Tools::generateNumber('order', 8, 'ORD', 'Ymd');

// 生成支付编号：PAY2025110812000001（包含时分秒）
$paymentNo = Tools::generateNumber('payment', 8, 'PAY', 'YmdHis');

// 生成退款编号：REF00000001（不包含日期）
$refundNo = Tools::generateNumber('refund', 8, 'REF', null);
```

**特性**：
- ✅ 唯一性：使用 Redis 原子操作保证并发安全
- ✅ 自动过期：带日期的编号会在第二天 0 点自动过期
- ✅ 灵活配置：支持自定义前缀、长度和日期格式
- ✅ 业务隔离：通过 `type` 参数区分不同业务，互不干扰

## 9. API 文档系统

### Swagger 集成

框架集成 Swagger，自动生成 API 文档。使用 Swagger 注解配置路由和 API 文档。

```php
// config/autoload/swagger.php
return [
    'enable' => env('APP_DEBUG', false),
    'port' => (int)env('APP_DOC_PORT'),
    'url' => '/swagger',
    'auto_generate' => true,
];
```

### 注解使用

```php
#[Schema(title: '用户注册', description: '用户注册请求参数')]
class UserRequest extends FormRequest
{
    #[Property(description: '用户名', type: 'string')]
    public string $username;
}
```

> 💡 **详细配置**：Swagger 完整配置说明请参考 [配置说明文档](./配置说明.md#6-swagger配置)

## 10. WebSocket 功能

FastApp 提供了完整的 WebSocket 服务器解决方案，支持 JWT 认证、多设备在线、插件化消息处理器等功能。

### 核心特性

- JWT Token 认证
- 多设备同时在线
- 插件化消息处理器
- 自动注册机制
- 协程安全的连接管理
- 统一的响应格式

详细文档请参考 [WebSocket开发文档](./WebSocket开发文档.md)

## 11. 插件系统

FastApp 提供了完整的插件系统，支持插件开发、安装、管理和卸载。

### 核心特性

- 前后端分离开发
- 数据库迁移支持
- 依赖管理
- 生命周期控制

详细文档请参考 [插件系统使用指南](./插件系统使用指南.md)
